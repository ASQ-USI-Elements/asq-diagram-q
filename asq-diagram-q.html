<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../asq-base/asq-base.html">

<link rel="import" href="elements/asq-diagram-q-shared/asq-diagram-q-shared-styles.html">
<link rel="import" href="elements/asq-diagram-q-shared/asq-diagram-q-shared-utilities.html">

<link rel="import" href="elements/asq-diagram-q-viewer/asq-diagram-q-viewer.html">
<link rel="import" href="elements/asq-diagram-q-presenter/asq-diagram-q-presenter.html">

<!--
`asq-diagram-q`is used to allow the user to draw diagrams. The supported diagram types are `uml` (default one), `erd` and `bpmn`, to change this option the user has to set the `type` attribute.

`width` and `height` attributes are used to set the size of the paper element, by default it is 500x500 pixels.

`asq-diagram-q`'s elements inherit several behaviours, the following is the complete list:

  - `ASQ.asqQuestionElementBehavior` and `ASQ.diagramQGlobalBehaviour`, inherited by all elements,

  - `ASQ.diagramQCommonUIBehaviour`, inherited by all actual diagram elements (e.g. element's name ending with `-bpmn.html`, `-uml.html`, etc.),

  - `ASQ.diagramQPresenterBehaviour`, inherited by all presenter elements (excluding the presenter's root `asq-diagram-q-presenter.html`).

In addition, for each diagram type there's a relative behaviour that implements the interface for that specific type (e.g. `asq-diagram-q-viewer-bpmn.html` uses `ASQ.diagramQBPMNBehaviour`).

Example 1:

    <asq-diagram-q id="bpmn-demo"  name="bpmnDiagram" type="bpmn" width="650" height="500">
      <asq-stem>This is a demo of bpmn diagram</asq-stem>
    </asq-diagram-q>

Using the `value` attribute it is possible to set a starting diagram value.

Example 2:

    <asq-diagram-q id="bpmn-demo-2"  name="bpmnDiagram2" type="bpmn" width="800" height="600">
      <asq-stem>This is a demo of bpmn diagram with a starting value</asq-stem>
    </asq-diagram-q>

    <script>
      document.addEventListener('WebComponentsReady', function (evt) {
        var bpmn_demo_2 = document.getElementById('bpmn-demo-2');
        bpmn_demo_2.value = {
          states: [...],
          relations: [...],
          type: 'bpmn'
        };
      });
    </script>

@element asq-diagram-q
@demo demo/index.html
@group ASQ Elements
@blurb Element acting as an editor for diagram questions.
@homepage http://github.com/ASQ-USI-Elements/asq-diagram-q
-->
<dom-module id="asq-diagram-q">

  <template>
    <div id="header">
      <p><content></content></p>
    </div>
    <template is="dom-if" if="{{hasRole(role, roles.VIEWER)}}" restamp>
      <asq-diagram-q-viewer
              role="viewer"
              uid="[[uid]]"
              name="[[name]]"
              value="{{value}}"
              disabled="{{disabled}}"
              type="[[type]]"
              width="[[width]]"
              height="[[height]]"
              link-pinning="[[linkPinning]]"
              event-bus="[[eventBus]]">
      </asq-diagram-q-viewer>
    </template>

    <template is="dom-if" if="{{hasRole(role, roles.PRESENTER)}}" restamp>
      <asq-diagram-q-presenter
              role="presenter"
              uid="[[uid]]"
              name="[[name]]"
              disabled="{{disabled}}"
              type="[[type]]"
              width="[[width]]"
              height="[[height]]"
              link-pinning="[[linkPinning]]"
              event-bus="[[eventBus]]">
      </asq-diagram-q-presenter>
    </template>
  </template>

  <script>
    Polymer({
      is: 'asq-diagram-q',

      behaviors: [
        ASQ.asqQuestionElementBehavior,
        ASQ.diagramQGlobalBehaviour
      ],

      properties: {

        _supported_types : {
          type: Array,
          value: ['uml', 'erd', 'bpmn']
        },

        /**
         * Type of diagram (default is uml)
         * options = 'uml', 'erd', 'bpmn'
         */

        type: {
          type: String,
          value: 'uml',
          notify: true,
          reflectToAttribute: true,
          observer: 'onTypeChanged'
        },

        /**
         * An optional initial set of states/relations.
         */
        value: {
          type: Object,
          notify: true
        },

        /**
         * Event bus to communicate with ASQ
         */
        eventBus: {
          type: Object,
          notify: true
        }
      },

      created: function () {
        document.addEventListener('asq-ready', function (evt) {
          this.eventBus = evt.detail.asqEventBus
        }.bind(this));
      },

      /**
       * Collect answers from inner `asq-option`s and orgnize them
       * into an object.
       *

       {
         uid: this.uid,
         timestamp: new Date(),
         options: options
       }

       */
      submit: function () {
        if (this.role == this.roles.VIEWER) {
          var el = this.$$('asq-diagram-q-viewer');
          if (!el) {
            throw new Error('submit(): expected asq-diagram-viewer element to exist');
          }
          return el.submit();
        }
      },

      onTypeChanged: function (val) {
        if(!this._supported_types.includes(val))
          this.type = 'uml'
      }
    });

  </script>

</dom-module>
