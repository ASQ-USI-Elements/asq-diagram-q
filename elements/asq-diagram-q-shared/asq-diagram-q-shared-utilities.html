<script type="text/javascript" src="../../../jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="../../../lodash/lodash.js"></script>
<script type="text/javascript" src="../../../backbone/backbone.js"></script>
<script type="text/javascript" src="../../../jointjs/dist/joint.js"></script>

<script>

  window.ASQDiagramQBehavior = window.ASQDiagramQBehavior || {};

  ASQDiagramQBehavior = {

    /** Initialization */

    _setKeyAndMouseEventListeners: function() {
      document.addEventListener('keydown',this._keyHandler.bind(this));
      document.addEventListener('keyup',this._keyHandler.bind(this));
      this.$['paper-container'].addEventListener('mousemove',this.dragPaper.bind(this));
    },

    _setJointJsEventListeners: function() {
      this._paper.on('cell:pointerclick', this._selectJointjsObject.bind(this));
      this._paper.on('link:options', this._selectJointjsObject.bind(this));
      this._paper.on('link:pointerdown', this._deselectJointjsObj.bind(this));
      this._paper.on('blank:pointerclick', this._deselectJointjsObj.bind(this));
      this._paper.on('blank:pointerdown', this.onDragStart.bind(this));
      this._paper.on('cell:pointerup blank:pointerup', this.onDragEnd.bind(this));
    },

    _setCellHighlighter: function() {
      this.highlighter = {
        highlighter: {
          name: 'stroke',
          options: {
            padding: 10,
            rx: 5,
            ry: 5,
            attrs: { 'stroke-width': 2, stroke: '#FF0000' }
          }
        }
      }
    },

    _getShapes: function(diagramType) {
      if(diagramType === 'uml')
        return {
          states : ['Class','Abstract','Interface'],
          relations: ['Generalization','Implementation', 'Aggregation','Composition','Association']
        };
      else if(diagramType === 'erd')
        return {
          states : {
            entities: ['Entity','Weak Entity'],
            relationships: ['Relationship','Identifying Relationship','ISA'],
            attributes: ['Attribute','Key','Multivalued','Derived']
          },
          relations: ['Line']
        };
    },

    /** Expand/collapse sidebar */

    _expandSidebar: function() {
      var bar = this.$['sidebar'].className = 'open';
      var btn = this.$['sidebar-button'].firstChild.icon='chevron-left';
    },

    _collapseSidebar: function() {
      var bar = this.$['sidebar'].className = 'closed';
      var btn = this.$['sidebar-button'].firstChild.icon='chevron-right';
    },

    /** State creation */

    _umlStatePropertiesToJSONObj: function(name, attributes, methods, position, size) {
      return {name: name, attributes: attributes, methods: methods, position: position, size: size}
    },

    _getUMLAttrs: function(type) {

    var attrs = {
      '.uml-class-name-text': {
        fontSize: 12,
        fontFamily: 'Courier'
      },
      '.uml-class-attrs-text, .uml-class-methods-text': {
        fontSize: 10,
        fontFamily: 'Courier'
      }
    };

    if (type.toLowerCase() === 'class') {
      attrs['.uml-class-name-rect'] = {
        fill: '#ff8450',
        stroke: '#fff',
        'stroke-width': 0.5
      };

      attrs['.uml-class-attrs-rect, .uml-class-methods-rect'] = {
        fill: '#fe976a',
        stroke: '#fff',
        'stroke-width': 0.5
      };

      attrs['.uml-class-attrs-text'] = {
        ref: '.uml-class-attrs-rect',
        'ref-y': 0.5,
        'y-alignment': 'middle'
      };

      attrs['.uml-class-methods-text'] = {
        ref: '.uml-class-methods-rect',
        'ref-y': 0.5,
        'y-alignment': 'middle'
      };
    }

    else if (type.toLowerCase() === 'abstract') {
      attrs['.uml-class-name-rect'] = {
        fill: '#68ddd5',
        stroke: '#ffffff',
        'stroke-width': 0.5
      };

      attrs['.uml-class-attrs-rect, .uml-class-methods-rect'] = {
        fill: '#9687fe',
        stroke: '#fff',
        'stroke-width': 0.5
      };

      attrs['.uml-class-methods-text, .uml-class-attrs-text'] = {
        fill: '#fff'
      };
    }

    else {
      attrs['.uml-class-name-rect'] = {
        fill: '#feb662',
        stroke: '#ffffff',
        'stroke-width': 0.5
      };

      attrs['.uml-class-attrs-rect, .uml-class-methods-rect'] = {
        fill: '#fdc886',
        stroke: '#fff',
        'stroke-width': 0.5
      };

      attrs['.uml-class-attrs-text'] = {
        ref: '.uml-class-attrs-rect',
        'ref-y': 0.5,
        'y-alignment': 'middle'
      };

      attrs['.uml-class-methods-text'] = {
        ref: '.uml-class-methods-rect',
        'ref-y': 0.5,
        'y-alignment': 'middle'
      };
    }
    return attrs;
  },

    _getERDAttrs: function(type, label) {
      if (type !== 'ISA')
        return { text: { text: label }};
      else
        return {};
    },

    _getNewStatePosition: function(){

      var random = Math.random()*(25 - (-25) + (-25));
      var container = this.$['paper-container'];
      var paper = this.$['paper'];

      var w = this.width,
        h = this.height;

      if(w > paper.offsetWidth)
        w = paper.offsetWidth;
      if(h > paper.offsetHeight)
        h = paper.offsetHeight;

      return {
        x: (w/(2*this._scale))+container.scrollLeft+random,
        y: (h/(2*this._scale))+container.scrollTop+random
      }
    },

    /** Relation creation */

    _relationPropertiesToJSONObj: function(source, target) {
      return {source: source, target: target}
    },

    _getNewLinkPosition: function(state) {
      var pos =  state.model.get('position');
      var size =  state.model.get('size');

      // var source = { x :pos.x, y : pos.y+(size.height/2) };
      var source = { id:state.model.get('id') };
      var target = { x : pos.x+size.width+25, y : pos.y+(size.height/2) };

      return {source:source, target:target}
    },

    _getNewRelAttrs: function() {
      return {
        '.connection': { visibility: 'hidden'},
        '.marker-source': { visibility: 'hidden'},
        '.connection-wrap':{ visibility: 'hidden'},
        '.labels':{ visibility: 'hidden'},
        '.marker-vertices':{ visibility: 'hidden', 'pointer-events' : 'none'},
        '.marker-arrowhead-group.marker-arrowhead-group-source':{ visibility: 'hidden'},
        '.link-tools':{ visibility: 'hidden'},
        '.marker-target': { stroke: '#FF0000', fill: '#FF0000', d:'M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z'}
      }
    },

    _getDefaultUMLRelAttrs: function() {
      return {'.marker-target': {d: 'M 20 0 L 0 10 L 20 20 z', fill: 'white'}};
    },

    _createLabels: function(sLabel, tLabel) {
      return {
        labels: [
          {
            position: 20,
            attrs: {
              text: { dy: -8, text: sLabel, fill: '#000000' },
              rect: { fill: '#ffffff' }
            }
          },
          {
            position: -20,
            attrs: {
              text: { dy: -8, text: tLabel, fill: '#000000' },
              rect: { fill: '#ffffff' }
            }
          }]
      };
    },

    /** State Edit */

    _getUMLModelData: function(model, isState) {
      var type = this._getUMLModelSubType(model,isState);
      if (isState)
        return {
          name: model.name,
          type: type,
          attributes: model.attributes,
          methods: model.methods
        };
      else
        return {
          type: type,
          source: model.source,
          target: model.target
        }
    },

    _getUMLModelSubType: function(model, isState) {
      var subType, collection = isState? this._getShapes('uml').states : this._getShapes('uml').relations;

      collection.forEach(function (value) {
        subType = model.type.includes(value)? value : subType;
      });
      return subType;
    },

    _getERDModelData: function(model, isState){
      var type = this._getERDModelSubType(model,isState);
      if (isState)
        return {
          type: type,
          label: type.includes('ISA')? '' : model.attrs.text.text
        };
      else
        return {
          source: model.source,
          target: model.target,
          sLabel: model.labels[0].attrs.text.text,
          tLabel: model.labels[1].attrs.text.text
        }
    },

    _getERDModelSubType: function(model, isState){
      var subType, collection = isState? this._getShapes('erd').states : this._getShapes('erd').relations;

      if(!Array.isArray(collection)){
        collection = this._shapesObjToArray(collection);
      }

      if(model.type.includes('Normal'))
        model.type = 'Attribute';

      collection.forEach(function (value) {
        if(model.type.toLowerCase().replace(/erd./g, '') === value.toLowerCase().replace(/\s/g, ''))
          subType = value;
      });
      return subType;
    },

    _shapesObjToArray: function(obj) {
      var array=[];
      Object.keys(obj).forEach(function (arr) {
        obj[arr].forEach(function (el) {
          array.push(el);
        });
      });
      return array;
    },

    _getValuesFromTable: function(table) {
      var rows = table.querySelectorAll('paper-input');
      return Array.prototype.slice.call(rows).filter(function(el){
        return !!el.value.trim();
      }).map(function (x) {
        return x.value.trim();
      });
    },

    /** Helper functions */

    _computeViewerSize: function (h,w) {
      this.$['app-body'].style = 'height:' + h + 'px;' + 'width:' + w + 'px;';
      this.$['paper-container'].style = 'height:' + h + 'px;' + 'width:' + (w-10) + 'px;';
      this.$['sidebar'].style.height = h+'px';
    },

    _computePresenterSize: function (h, w){
      this.$['app-body'].style = 'height:' + h + 'px;' + 'width:' + w + 'px;';
      this.$['submissions'].style = 'height:' + (h-40) + 'px;' + 'width:' + w + 'px;';
    },

    _computeSubmissionSize: function(h,w) {
      this.$['paper'].style = 'height:' + h + 'px;' + 'width:' + w + 'px;';
    },

    _getMax: function(a,b) {
      if(a === -1 || (a !== -1 && a < b) )
        return b;
      return a;
    },

    _getMin: function(a,b) {
      if(a === -1 || (a !== -1 && a > b) )
        return b;
      return a;
    },

    _findStateByName: function(diagramType, states, name) {
      var ids = Object.keys(states)
      if(diagramType === 'uml')
        for(var i=0;i<ids.length;i++){
          if(states[ids[i]].state.name === name)
            return ids[i];
        }
      else if(diagramType === 'erd')
        for(var i=0;i<ids.length;i++){
          if(states[ids[i]].label === name)
            return ids[i];
        }

      return false;
    },

    _scalePaper: function(t) {
      this.$['paper'].style = 'height:' + (1920*this._scale) + 'px;' + 'width:' + (1920*this._scale) + 'px;';
    },

    _showStateErrorMessage: function(el, type, name) {
      var err;
      if (!type)
        err='- please choose a type';
      else if (!name)
        err='- please enter a name';

      if(err) {
        this._showError(el,err);
        return true;
      }
      return false;
    },

    _showRelationErrorMessage: function(el, source, target){
      var err;
      if (!source)
        err='- please choose the source';
      else if (!target)
        err='- please choose the target';
      else if (source.id === target.id)
        err='- source and target are the same';

      if(err) {
        this._showError(el,err);
        return true;
      }
      return false;
    },

    _showERDStateErrorMessage: function(el, type, label) {
      var err;
      if (!type)
        err='- please choose a type';
      else if (!label && type !== 'ISA')
        err='- please enter a label';

      if(err) {
        this._showError(el,err);
        return true;
      }
      return false;
    },

    _showError: function(el, text) {
      var err = el.querySelector('div[id=error]');
      if(err){
        err.style = 'visibility:visible';
        err.querySelector('p[id=whichError]').innerHTML = text;
        setTimeout(function(){
          err.removeAttribute('style');
        }, 2000);
      }
    },

    _findRelations: function(id, relations) {
      var rel = [];
      Object.keys(relations).forEach(function (r) {
        if (relations[r].relation.source.id === id || relations[r].relation.target.id === id)
          rel.push(r);
      });
      return rel;
    },

    _computeJointJsStateSize: function(name, attributes, methods) {
      var arr = [name].concat(attributes, methods);
      return {
        width: this._computeStateWidth(arr) + 2, // + 2 for margins
        height: Math.max(50, 2 * 15 + (arr.length) * 12)
      }
    },

    _computeStateWidth: function(arr) {
      var w = 0;
      for (var i = 0; i < arr.length; i++) {
        w = Math.max(w, this._getWidthOfText(arr[i], (i===0)))
      }
      return Math.max(Math.max(w),100);
    },

    _getWidthOfText: function(txt, bold) {
      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d');
      ctx.font = bold ? '12.5px Courier' : '10.4px Courier';
      return ctx.measureText(txt).width;
    }
  };

</script>