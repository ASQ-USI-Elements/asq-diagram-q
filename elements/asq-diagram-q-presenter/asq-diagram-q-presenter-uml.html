<link rel="import" href="../../../iron-icon/iron-icon.html">
<link rel="import" href="../../../iron-icons/iron-icons.html">

<!--
`asq-diagram-q-presenter-uml` is used to show to the presenter.

@element asq-diagram-q-presenter-uml
@demo demo/index.html
@group ASQ Elements
@blurb Element acting as an editor for diagram questions.
@homepage http://github.com/ASQ-USI-Elements/asq-diagram-q
-->
<dom-module id='asq-diagram-q-presenter-uml'>

  <template>
    <style include='asq-diagram-q-shared-styles'></style>

    <div id='paper'></div>
  </template>

  <script>
    Polymer({
      is: 'asq-diagram-q-presenter-uml',

      behaviors: [
        ASQ.asqQuestionElementBehavior,
        ASQDiagramQBehavior
      ],

      listeners: {},

      keyBindings: {},

      hostAttributes: {},

      properties: {
        /**
         * width in pixels of the paper element
         */
        width: {
          type: Number,
          notify: true,
          reflectToAttribute: true,
          observer: '_setSize'
        },

        /**
         * height in pixels of the paper element
         */
        height: {
          type: Number,
          notify: true,
          reflectToAttribute: true,
          observer: '_setSize'
        },

        /**
         * diagram value
         */
        value: {
          type: Object,
          notify: true,
          // observer: '_valueChanged'
        },

        /**
         * The grap object
         *  @type {Object}
         */
        _graph: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The paper object
         *  @type {Object}
         */
        _paper: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The scale value
         */
        _scale: {
          type: Number,
          value: 1,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The uml object
         *  @type {Object}
         */
        _uml: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },
      },

      attached: function () {
        this.async(function () {
          this.init();
        });
      },
      /**
       * set up phase
       */
      init: function () {
        this._graph = new joint.dia.Graph();
        this._paper = new joint.dia.Paper({
          el: this.$.paper,
          width: this.width,
          height: this.height,
          model: this._graph,
          gridSize: 10,
          drawGrid:true,
          interactive: false
        });
        this._uml = joint.shapes.uml;

        if(this.value) {
          var offset = this.getPaperSize(this.value);
          this.fillGraph(this.value, offset)
        }
        this.initialized = true;
      },

      _setSize: function (newVal,oldVal) {
        computeSubmissionSize(this.height, this.width, this);

        if(this.initialized) {
          if(!this._scaleDone){
            this._scale*= (newVal/oldVal)
            this._paper.scale(this._scale, this._scale);
            this._scaleDone = true;
          } else{
            this._scaleDone = false;
          }
        }
      },

      fillGraph: function (value, offset) {

        var dict = {};

        value.states.forEach(function(s){
          var position = {
            x: s.state.position.x - offset.offX,
            y: s.state.position.y - offset.offY
          };
          dict[s.state.name] = this.addState(s.type, s.state.name, s.state.attributes, s.state.methods, position, s.state.size);
        }.bind(this));

        value.relations.forEach(function(rel){
          var sourceId = dict[rel.relation.source.name];
          var targetId = dict[rel.relation.target.name];

          var rId = this.addRelation( rel.type, { id: sourceId }, { id: targetId } );
          if(rel.vertices){
            var vertices = [];
            rel.vertices.forEach(function (v) {
              vertices.push({
                x : v.x - offset.offX,
                y : v.y - offset.offY
              });
            });

            this._graph.getCell(rId).set('vertices',vertices)
          }
        }.bind(this));

      },

      getPaperSize: function (value) {
        var coord = {
          x0: -1,
          x1: -1,
          y0: -1,
          y1: -1
        };

        value.states.forEach(function (s) {
          var x = s.state.position.x;
          var y = s.state.position.y;

          coord.x0 = getMin(coord.x0, x);
          coord.x1 = getMax(coord.x1, (x + s.state.size.width) );
          coord.y0 = getMin(coord.y0, y);
          coord.y1 = getMax(coord.y1, (y + s.state.size.height) );
        });

        value.relations.forEach(function (r) {
          if(r.vertices)
            r.vertices.forEach(function (v) {
              var x = v.x;
              var y = v.y;

              coord.x0 = getMin(coord.x0, x);
              coord.x1 = getMax(coord.x1, x );
              coord.y0 = getMin(coord.y0, y);
              coord.y1 = getMax(coord.y1, y);
            })
        });

        var pWidth = coord.x1 - coord.x0 + 40;
        var pHeight = coord.y1 - coord.y0 + 40;


        if(this._paper){
          var p1 = this.height/pHeight;
          var p2 = this.width/pWidth;

          if(p1 < p2) {
            this._paper.scale(p1, p1);
            this._scale = p1
          }
          else {
            this._paper.scale(p2, p2);
            this._scale = p2
          }
        }

        return {
          offX: coord.x0 -20,
          offY: coord.y0 -20,
        };
      },

      addState: function (type, name, attributes, methods, position, size) {
        var state = this._createState(type, {name: name, attributes: attributes, methods: methods, position:position, size:size});
        this._graph.addCell(state)

        return state.id;
      },

      _createState: function (type, state) {
        state.attrs = getUMLAttrs(type);

        if (type.toLowerCase() === 'class')
          return new this._uml.Class(state);
        else if (type.toLowerCase() === 'abstract')
          return new this._uml.Abstract(state);
        else
          return new this._uml.Interface(state);
      },

      addRelation: function (type, source, target) {

        var rel = this._createRelation(type, {source: source, target: target});
        this._graph.addCell(rel);

        return rel.id;
      },

      _createRelation: function (type, relation) {
        if (type.toLowerCase() === 'generalization')
          return new this._uml.Generalization(relation);

        else if (type.toLowerCase() === 'implementation')
          return new this._uml.Implementation(relation);

        else if (type.toLowerCase() === 'aggregation')
          return new this._uml.Aggregation(relation);

        else if (type.toLowerCase() === 'composition')
          return new this._uml.Composition(relation);

        else
          return new this._uml.Association(relation);
      }

    });
  </script>

</dom-module>
