<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../asq-base/asq-base.html">
<link rel="import" href="../../iron-icon/iron-icon.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../paper-listbox/paper-listbox.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-input/paper-input.html">


<link rel="import" href="./asq-diagram-q-shared/asq-diagram-q-shared-styles.html">
<link rel="import" href="./asq-diagram-q-shared/asq-diagram-q-shared-libraries.html">


<!--
`asq-diagram-q-viewer` is use to show to the viewer.

@element asq-diagram-q-viewer
@demo demo/index.html
@group ASQ Elements
@blurb Element acting as an editor for diagram questions.
@homepage http://github.com/ASQ-USI-Elements/asq-diagram-q
-->
<dom-module id='asq-diagram-q-viewer'>

  <template>
    <style include='asq-diagram-q-shared-styles'>
      .link-tools .tool-options {
        display: block; /* by default is 'none' but we want to use it */
      }
    </style>

    <div id="header">
      <p><content></content></p>
    </div>

    <div id="app-body">

      <div id="sidebar" class="open">
        <div id="sidebar-content">
          <template is="dom-if" if="{{_nothingSelected(selectedCounter)}}" restamp>
            <div class="menu state">
              <div class="expand-button">
                <paper-button raised on-click="_expandStateMenu"><iron-icon icon="{{_getIcon(_showStateContent)}}"></iron-icon><h4 class="button-label">NEW STATE</h4></paper-button>
              </div>
              <template is="dom-if" if="{{_showStateContent}}" restamp>
                <div class="menu-content">
                  <div class="menu-element" id="name">
                    <iron-label>
                      <span>Name</span>
                    </iron-label>
                    <paper-input></paper-input>
                  </div>
                  <div class="menu-element" id="type">
                    <paper-dropdown-menu class="drop-down" label="Type" horizontal-align="left">
                      <paper-listbox class="dropdown-content">
                        <template is="dom-repeat" items="{{_types.states}}" restamp>
                          <paper-item>{{item}}</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>
                  </div>
                  <div class="menu-element" id="attributes">
                    <iron-label>
                      <span>Attributes</span><paper-icon-button icon="add-circle-outline" type="add" property="attributes" on-click="_addRow"></paper-icon-button>
                    </iron-label>
                    <table></table>
                  </div>
                  <div class="menu-element" id="methods">
                    <iron-label>
                      <span>Methods</span><paper-icon-button icon="add-circle-outline" type="add" property="methods" on-click="_addRow"></paper-icon-button>
                    </iron-label>
                    <table></table>
                  </div>
                  <div class="menu-element error-message" id="error">
                    <p>Submission not valid:</p>
                    <p id="whichError">- error message -</p>
                  </div>
                  <div class="menu-element" id="buttons">
                    <paper-button raised on-click="newJointJsState"><div><iron-icon icon="note-add"></iron-icon></div><div><h4 class="button-label">CREATE</h4></div></paper-button>
                    <paper-button raised on-click="_expandStateMenu"><div><iron-icon icon="block"></iron-icon></div><div><h4 class="button-label">CLEAR</h4></div></paper-button>
                  </div>
                </div>
              </template>
            </div>
            <div class="menu link">
              <div class="expand-button">
                <paper-button raised on-click="_expandRelationMenu"><iron-icon icon="{{_getIcon(_showLinkContent)}}"></iron-icon><h4 class="button-label">CONNECT</h4></paper-button>
              </div>
              <template is="dom-if" if="{{_showLinkContent}}" restamp>
                <div class="menu-content">
                  <div class="menu-element" id="type">
                    <paper-dropdown-menu class="drop-down" label="Type" horizontal-align="left">
                      <paper-listbox class="dropdown-content">
                        <template is="dom-repeat" items="{{_types.relations}}" restamp>
                          <paper-item>{{item}}</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>
                  </div>
                  <div class="menu-element" id="relation">
                    <paper-dropdown-menu class="drop-down" id="source" label="Source" horizontal-align="left">
                      <paper-listbox class="dropdown-content">
                        <template is="dom-repeat" items="{{_mapToArrayOfObjects(_states)}}">
                          <paper-item id="{{item.id}}">{{item.text}}</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu class="drop-down" id="target" label="Target" horizontal-align="left">
                      <paper-listbox class="dropdown-content">
                        <template is="dom-repeat" items="{{_mapToArrayOfObjects(_states)}}">
                          <paper-item id="{{item.id}}">{{item.text}}</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>
                  </div>
                  <div class="menu-element error-message" id="error">
                    <p>Submission not valid:</p>
                    <p id="whichError">- error message -</p>
                  </div>
                  <div class="menu-element" id="buttons">
                    <paper-button raised on-click="newJointJsRelation"><div><iron-icon icon="note-add"></iron-icon></div><div><h4 class="button-label">CONNECT</h4></div></paper-button>
                    <paper-button raised on-click="_expandRelationMenu"><div><iron-icon icon="block"></iron-icon></div><div><h4 class="button-label">CLEAR</h4></div></paper-button>
                  </div>
                </div>
              </template>
            </div>
          </template>
          <template is="dom-if" if="{{_somethingSelected(selectedCounter)}}" restamp>
            <div class="menu edit">
              <div class="expand-button">
                <paper-button raised on-click="_expandEditMenu"><iron-icon icon="{{_getIcon(_showEditContent)}}"></iron-icon><h4 class="button-label">EDIT</h4></paper-button>
              </div>
              <div class="menu-content">
                <template is="dom-if" if="{{_showEditContent}}" restamp>
                  <template is="dom-if" if="{{_oneSelected(selectedCounter)}}" restamp>
                    <!--Name-->
                    <template is="dom-if" if="{{_isType('state', selected)}}" restamp>
                      <div class="menu-element" id="name">
                        <iron-label>
                          <span>Name</span>
                        </iron-label>
                        <paper-input value="[[selected.model.attributes.name]]" on-input="_onNameChanged"></paper-input>
                      </div>
                    </template>
                    <!--Type-->
                    <div class="menu-element" id="type">

                      <paper-dropdown-menu class="drop-down" label="Type" horizontal-align="left" on-value-changed="_onTypeChanged">

                        <template is="dom-if" if="{{_isType('state', selected)}}" restamp>
                          <paper-listbox class="dropdown-content" selected="{{_getIndexOfItem(selected.model.attributes.type,_types.states)}}">
                            <template is="dom-repeat" items="{{_types.states}}" restamp>
                              <paper-item>[[item]]</paper-item>
                            </template>
                          </paper-listbox>
                        </template>

                        <template is="dom-if" if="{{_isType('relation', selected)}}" restamp>
                          <paper-listbox class="dropdown-content" selected="{{_getIndexOfItem(selected.model.attributes.type,_types.relations)}}">
                            <template is="dom-repeat" items="{{_types.relations}}" restamp>
                              <paper-item>[[item]]</paper-item>
                            </template>
                          </paper-listbox>
                        </template>

                      </paper-dropdown-menu>
                    </div>
                    <!--Attributes and Methods-->
                    <template is="dom-if" if="{{_isType('state', selected)}}" restamp>
                      <div class="menu-element" id="attributes">
                        <iron-label>
                          <span>Attributes</span><paper-icon-button icon="add-circle-outline" edit="attributes" on-click="_addRow"></paper-icon-button>
                        </iron-label>
                        <table edit="attributes">
                          <tbody>
                          <template is="dom-repeat" items="{{selected.model.attributes.attributes}}">
                            <tr>
                              <td>{{_inc(index)}}:</td>
                              <td><paper-input value="[[item]]" on-input="_onAttributeChanged"><iron-icon suffix icon="remove-circle" on-click="_removeRow"></iron-icon></paper-input></td>
                            </tr>
                          </template>
                          </tbody>
                        </table>
                      </div>
                      <div class="menu-element" id="methods">
                        <iron-label>
                          <span>Methods</span><paper-icon-button icon="add-circle-outline" edit="methods" on-click="_addRow"></paper-icon-button>
                        </iron-label>
                        <table edit="methods">
                          <tbody>
                          <template is="dom-repeat" items="{{selected.model.attributes.methods}}">
                            <tr>
                              <td>{{_inc(index)}}:</td>
                              <td><paper-input value="[[item]]" on-input="_onMethodChanged"><iron-icon suffix icon="remove-circle" on-click="_removeRow"></iron-icon></paper-input></td>
                            </tr>
                          </template>
                          </tbody>
                        </table>
                      </div>
                    </template>
                    <!--Source and Target-->
                    <template is="dom-if" if="{{_isType('relation', selected)}}" restamp>
                      <div class="menu-element" id="relation">
                        <paper-dropdown-menu class="drop-down" id="source" label="Source" horizontal-align="left" on-selected-item-changed="_changeRelationSourceAndTarget">
                          <paper-listbox class="dropdown-content" selected="{{_getIndexOfItem(selected.model.attributes.source.id, _states)}}">
                            <template is="dom-repeat" items="{{_mapToArrayOfObjects(_states)}}">
                              <paper-item id="[[item.id]]">[[item.text]]</paper-item>
                            </template>
                          </paper-listbox>
                        </paper-dropdown-menu>

                        <paper-dropdown-menu class="drop-down" id="target" label="Target" horizontal-align="left" on-selected-item-changed="_changeRelationSourceAndTarget">
                          <paper-listbox class="dropdown-content" selected="{{_getIndexOfItem(selected.model.attributes.target.id, _states)}}">
                            <template is="dom-repeat" items="{{_mapToArrayOfObjects(_states)}}">
                              <paper-item id="[[item.id]]">[[item.text]]</paper-item>
                            </template>
                          </paper-listbox>
                        </paper-dropdown-menu>
                      </div>
                    </template>
                    <!--error-->
                    <div class="menu-element error-message" id="error">
                      <p>Submission not valid:</p>
                      <p id="whichError">- error message -</p>
                    </div>
                    <!--Buttons-->
                    <div class="menu-element" id="buttons">
                      <paper-button raised on-click="_saveChanges"><div><iron-icon icon="save"></iron-icon></div><div><h4 class="button-label">SAVE</h4></div></paper-button>
                      <template is="dom-if" if="{{_isType('state', selected)}}" restamp>
                        <paper-button raised on-click="_onJointjsObjDeselected"><div><iron-icon icon="content-copy"></iron-icon></div><div><h4 class="button-label">CLONE</h4></div></paper-button>
                      </template>
                      <paper-button raised on-click="_onClearButtonClicked"><div><iron-icon icon="block"></iron-icon></div><div><h4 class="button-label">CLEAR</h4></div></paper-button>
                      <paper-button raised on-click="_deleteSelected"><div><iron-icon icon="delete"></iron-icon></div><div><h4 class="button-label">DELETE</h4></div></paper-button>
                    </div>
                  </template>
                  <template is="dom-if" if="{{_twoSelected(selectedCounter)}}" restamp>
                    <div class="menu-element" id="buttons">
                      <paper-button raised on-click="_connectSelected"><div><iron-icon icon="link"></iron-icon></div><div><h4 class="button-label">CONNECT</h4></div></paper-button>
                      <paper-button raised on-click="_onClearButtonClicked"><div><iron-icon icon="block"></iron-icon></div><div><h4 class="button-label">CLEAR</h4></div></paper-button>
                      <paper-button raised on-click="_deleteSelected"><div><iron-icon icon="delete"></iron-icon></div><div><h4 class="button-label">DELETE</h4></div></paper-button>
                    </div>
                  </template>
                  <template is="dom-if" if="{{_multipleSelected(selectedCounter)}}" restamp>
                    <div class="menu-element" id="buttons">
                      <paper-button raised on-click="_onClearButtonClicked"><div><iron-icon icon="block"></iron-icon></div><div><h4 class="button-label">CLEAR</h4></div></paper-button>
                      <paper-button raised on-click="_deleteSelected"><div><iron-icon icon="delete"></iron-icon></div><div><h4 class="button-label">DELETE</h4></div></paper-button>
                    </div>
                  </template>
                </template>
              </div>
            </div>
          </template>
        </div>
        <div id="sidebar-button"><paper-icon-button icon="chevron-left" on-click="_expandOrCollapse"></paper-icon-button></div>
      </div>
      <div id='paper-container'><div id='paper'></div></div>
    </div>

  </template>

  <script>
    Polymer({
      is: 'asq-diagram-q-viewer',

      behaviors: [
        ASQ.asqElementBehavior
      ],

      listeners: {},

      keyBindings: {},

      hostAttributes: {},

      properties: {

        /**
         * Name of 'this' obj
         *  @type {String}
         */
        name: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Type of diagram (default is uml)
         * options = 'uml', 'er'
         */
        type: {
          type: String,
          value: 'uml',
          notify: true,
          reflectToAttribute: true
        },

        /**
         * width in pixels of the paper element
         */
        width: {
          type: Number,
          value: 600,
          notify: true,
          reflectToAttribute: true,
          observer: '_computeSize'
        },

        /**
         * height in pixels of the paper element
         */
        height: {
          type: Number,
          value: 600,
          notify: true,
          reflectToAttribute: true,
          observer: '_computeSize'
        },

        /**
         * The grap object
         *  @type {Object}
         */
        _graph: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The paper object
         *  @type {Object}
         */
        _paper: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },


        /**
         * The uml object
         *  @type {Object}
         */
        _uml: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Obj containing subtypes for every supported type
         *
         * eg. for uml diagram
         * _types = {
                states : ["Class","Abstract","Interface"],
                relations: ["Generalization","Implementation", "Aggregation","Composition","Association"]
                };
         */
        _types: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Object containing all created states
         *  @type {Object}
         */
        _states: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Object containing all created relations
         *  @type {Object}
         */
        _relations: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The selected state/relation
         */
        selected: {
          type: Object,
          value: null,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The selected state/relation copy for undo operation
         */
        selectedCopy: {
          type: Object,
          value: null,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The selected state
         */
        multiModeEnabled: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Array of selected cells
         */
        selectedElements: {
          type: Array,
          value: [],
          notify: true,
          reflectToAttribute: true
        },

        /**
         * True is multiple elements are selected
         */
        selectedCounter:{
          type: Number,
          value: 0,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The style of cell highlighter
         */
        highlighter: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        _showStateContent:{
          type: Boolean,
          value:false,
          notify: true,
          reflectToAttribute: true
        },

        _showLinkContent:{
          type: Boolean,
          value:false,
          notify: true,
          reflectToAttribute: true
        },

        _showEditContent:{
          type: Boolean,
          value:true,
          notify: true,
          reflectToAttribute: true
        }
      },

      attached: function () {
        this.async(function () {
          this.init();
        });
      },
      /**
       * set up phase
       */
      init: function () {

        this._graph = new joint.dia.Graph();
        this._paper = new joint.dia.Paper({
          el: this.$.paper,
          width: 1920,
          height: 1920,
          gridSize: 1,
          model: this._graph
        });

        this._states = {};
        this._relations = {};
        this.selectedElements = [];
        this._setJointJsEventListeners();
        this._setKeyboardEventListeners();
        this._setCellHighlighter();

        if (this.type === 'uml') {
          this._uml = joint.shapes.uml;
          this._types = {
            states : ["Class","Abstract","Interface"],
            relations: ["Generalization","Implementation", "Aggregation","Composition","Association"]
          };
        } else if (this.type === 'erd') {
          this._uml = joint.shapes.erd;
          this._types = {
            states : ["Entity","WeakEntity","Relationship","IdentifyingRelationship","Attribute","Multivalued","Derived","Key","Normal","ISA"],
            relations: ["Line"]
          };
        }
      },

      _setJointJsEventListeners: function () {
        this._paper.on('cell:pointerclick', this._selectJointjsObject.bind(this));
        this._paper.on('link:options', this._selectJointjsObject.bind(this));
        this._paper.on('link:pointerdown', this._deselectJointjsObj.bind(this));
        this._paper.on('blank:pointerclick', this._deselectJointjsObj.bind(this));
      },

      _setKeyboardEventListeners: function () {
        document.addEventListener('keydown',this._keyHandler.bind(this));
        document.addEventListener('keyup',this._keyHandler.bind(this));
      },

      _setCellHighlighter: function(){
        this.highlighter = {
          highlighter: {
            name: 'stroke',
            options: {
              padding: 10,
              rx: 5,
              ry: 5,
              attrs: {
                'stroke-width': 3,
                stroke: '#FF0000'
              }
            }
          }
        }
      },

      /**
       * expand/collapse sidebar
       */

      _expandOrCollapse: function () {

        if(this.$['sidebar'].className === "open")
          this._collapseSidebar();
        else
          this._expandSidebar();
      },

      _expandSidebar: function () {

        var bar = this.$['sidebar'];
        var btn = this.$['sidebar-button'].firstChild;
        bar.className = "open";
        btn.icon="chevron-left";
      },

      _collapseSidebar: function () {

        var bar = this.$['sidebar'];
        var btn = this.$['sidebar-button'].firstChild;
        bar.className = "closed";
        btn.icon="chevron-right";
      },

      /**
       * expand/collapse sidebar or various menu
       */

      _expandStateMenu: function () {
        this._showStateContent = !this._showStateContent
      },

      _collapseStateMenu: function () {
        this._showStateContent = false;
      },

      _expandRelationMenu: function () {
        this._showLinkContent = !this._showLinkContent
      },

      _collapseRelationMenu: function () {
        this._showLinkContent = false;
      },

      _expandEditMenu: function () {
        this._showEditContent = !this._showEditContent
      },

      _collapseEditMenu: function () {
        this._showEditContent = false;
      },

      _nothingSelected: function (counter) {
        return counter === 0;
      },

      _somethingSelected: function (counter) {
        return counter > 0;
      },

      _oneSelected: function(counter){
        return counter === 1;
      },

      _twoSelected: function(counter){
        return counter === 2 && this.selectedElements.every(function (el) {
          return this._isType('state',el);
        }.bind(this))
      },

      _multipleSelected: function(counter){
        return counter > 1 && !this._twoSelected(counter);
      },

      /**
       * State creation
       */

      newJointJsState: function () {
        var data = this._getStateFormData();
        if(!data) return;

        var position =  { x:this.width/2, y: this.height/2 };
        this.addState(data.type, data.name, data.attributes, data.methods, position);

        this._expandStateMenu();
      },

      _getStateFormData: function (typeChange) {
        var el = Polymer.dom(this.root).querySelector('div[class="menu state"] div[class=menu-content]') ||
          Polymer.dom(this.root).querySelector('div[class="menu edit"] div[class=menu-content]');
        var type = el.querySelector('paper-dropdown-menu').value;
        var name = el.querySelector('div[id=name] paper-input').value;

        if(!typeChange) {
          if (this.showStateErrorMessage(el, type, name))
            return;
        }

        var attrs = Array.prototype.slice.call(el.querySelectorAll('div[id=attributes] paper-input')).filter(function(el){
          return !!el.value.trim()
        }).map(function (x) {
          return x.value;
        });
        var methods = Array.prototype.slice.call(el.querySelectorAll('div[id=methods] paper-input')).filter(function(el){
          return !!el.value.trim()
        }).map(function (x) {
          var v = x.value.trim();
          if(v)
            return v.startsWith('+ ')? v : '+ '+v;
        });
        return { type:type, name:name, attributes:attrs, methods:methods }
      },

      addState: function (type, name, attributes, methods, position) {

        var state = this._statePropertiesToJSONObj(name, attributes, methods, position, this._computeJointJsStateSize(name, attributes, methods));
        var s = this._createState(type, state);
        this._graph.addCell(s);
        this._states[s.id] = {'type': type, 'cid': s.cid, 'state': state};

        s.on('change:position', this._onStatePositionChanged.bind(this)); // for handling position changes
        return s.id;
      },

      _statePropertiesToJSONObj: function (name, attributes, methods, position, size) {
        return {name: name, attributes: attributes, methods: methods, position: position, size: size}
      },

      _createState: function (type, state) {

        var s = _.clone(state);

        s.attrs = {
          '.uml-class-name-text': {
            fontSize: 12,
            fontFamily: 'Courier'
          },
          '.uml-class-attrs-text, .uml-class-methods-text': {
            fontSize: 10,
            fontFamily: 'Courier'
          }
        };

        if (type.toLowerCase() === 'class') {
          s.attrs['.uml-class-name-rect'] = {
            fill: '#ff8450',
            stroke: '#fff',
            'stroke-width': 0.5
          };

          s.attrs['.uml-class-attrs-rect, .uml-class-methods-rect'] = {
            fill: '#fe976a',
            stroke: '#fff',
            'stroke-width': 0.5
          };

          s.attrs['.uml-class-attrs-text'] = {
            ref: '.uml-class-attrs-rect',
            'ref-y': 0.5,
            'y-alignment': 'middle'
          };

          s.attrs['.uml-class-methods-text'] = {
            ref: '.uml-class-methods-rect',
            'ref-y': 0.5,
            'y-alignment': 'middle'
          };

          return new this._uml.Class(s)
        }

        else if (type.toLowerCase() === 'abstract') {
          s.attrs['.uml-class-name-rect'] = {
            fill: '#68ddd5',
            stroke: '#ffffff',
            'stroke-width': 0.5
          };

          s.attrs['.uml-class-attrs-rect, .uml-class-methods-rect'] = {
            fill: '#9687fe',
            stroke: '#fff',
            'stroke-width': 0.5
          };

          s.attrs['.uml-class-methods-text, .uml-class-attrs-text'] = {
            fill: '#fff'
          };
          return new this._uml.Abstract(s)

        }

        else {
          s.attrs['.uml-class-name-rect'] = {
            fill: '#feb662',
            stroke: '#ffffff',
            'stroke-width': 0.5
          };

          s.attrs['.uml-class-attrs-rect, .uml-class-methods-rect'] = {
            fill: '#fdc886',
            stroke: '#fff',
            'stroke-width': 0.5
          };

          s.attrs['.uml-class-attrs-text'] = {
            ref: '.uml-class-attrs-rect',
            'ref-y': 0.5,
            'y-alignment': 'middle'
          };

          s.attrs['.uml-class-methods-text'] = {
            ref: '.uml-class-methods-rect',
            'ref-y': 0.5,
            'y-alignment': 'middle'
          };
          return new this._uml.Interface(s);
        }
      },

      /**
       * Relation creation
       */

      newJointJsRelation: function() {
        var data = this._getRelationFormData();
        if(!data) return;

        this.addRelation(data.type, data.source, data.target);
        this._expandRelationMenu();
      },

      _getRelationFormData: function () {
        var el = Polymer.dom(this.root).querySelector('div[class="menu link"] div[class=menu-content]') ||
          Polymer.dom(this.root).querySelector('div[class="menu edit"] div[class=menu-content]');
        var type = el.querySelector('div[id=type] paper-dropdown-menu').value;
        var source = el.querySelector('div[id=relation] paper-dropdown-menu[id=source]').selectedItem;
        var target = el.querySelector('div[id=relation] paper-dropdown-menu[id=target]').selectedItem;

        if (this.showRelationErrorMessage(el, type, source, target)) return;
        return { type:type, source: {id: source.id}, target: {id: target.id }}
      },

      addRelation: function (type, source, target) {
        var relation = this._relationPropertiesToJSONObj(source, target);

        var r = this._createRelation(type, relation);
        this._graph.addCell(r);
        this._relations[r.id] = {'type': type, 'cid': r.cid, 'relation': relation};

        r.on('change:z', this._onRelationTargetOrSourceChanged.bind(this)); // handle source/target modifications
        r.on('remove', this._onRelationDeleted.bind(this)); // handle link deletion
        return r.id;
      },

      _relationPropertiesToJSONObj: function (source, target) {
        return {source: source, target: target}
      },

      _createRelation: function (type, relation) {
        if (type.toLowerCase() === 'generalization')
          return new this._uml.Generalization(relation);

        else if (type.toLowerCase() === 'implementation')
          return new this._uml.Implementation(relation);

        else if (type.toLowerCase() === 'aggregation')
          return new this._uml.Aggregation(relation);

        else if (type.toLowerCase() === 'composition')
          return new this._uml.Composition(relation);

        else
          return new this._uml.Association(relation);
      },

      _connectSelected: function () {
        var source = this.selectedElements[0].model.get('id')
        var target = this.selectedElements[1].model.get('id')

        this._multiDeselectAll();

        var id = this.addRelation(
          'generalization',
          {id: source},
          {id: target});

        this._singleSelect(this._graph.getCell(id).findView(this._paper));
      },

      _showNewLinkButton: function(state){
        if(this._isType('state', state) && !this.newRel){

          var pos =  state.model.get('position');
          var size =  state.model.get('size');
          var source = { x :pos.x, y : pos.y+(size.height/2) };
          var target = { x : pos.x+size.width+25, y : pos.y+(size.height/2) };

          var attr = {
            '.connection': { visibility: 'hidden'},
            '.marker-source': { visibility: 'hidden'},
            '.connection-wrap':{ visibility: 'hidden'},
            '.labels':{ visibility: 'hidden'},
            '.marker-vertices':{ visibility: 'hidden', 'pointer-events' : 'none'},
            '.marker-arrowhead-group.marker-arrowhead-group-source':{ visibility: 'hidden'},
            '.marker-arrowhead-group.marker-arrowhead-group-target':{  transform: 'scale(20)'},
            '.link-tools':{ visibility: 'hidden'},
            '.marker-target': { stroke: '#FF0000', fill: '#FF0000', d:'M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z'}
          };

          var id = this.addRelation('generalization',{id:state.model.get('id')},target);

          // var id = this.addRelation('generalization',source,target);

          this.newRel = this._graph.getCell(id);
          this.newRel.attr(attr);
          this.newRel.on('change:target', this._saveNewLink.bind(this));
        }
      },

      _saveNewLink: function (cell,val) {
        if(this.newRel) {
          var attr = {'.marker-target': {d: "M 20 0 L 0 10 L 20 20 z", fill: "white"}};
          this.newRel.set('attrs', {});
          this.newRel.attr(attr);
          this.newRel.findView(this._paper).render(); // instead of 'renderRelations' --> causing jointjs error
          this.newRel = null;
          this._deselectJointjsObj();
        }

        if(val.id){
          this._singleSelect(cell.findView(this._paper));
        }
      },


      /**
       * State edit
       */

      _onStatePositionChanged: function (state, pos) {
        this._states[state.id].state.position = pos;
        if(this.selected && this.selected.model.get('id')===state.id){
         this._updateNewRelTargetPosition();
        }
        else if(this.selected && this.selected.model.attributes.source)
          this._onJointjsObjDeselected();
      },

      _onNameChanged: function(e){
        this._editAttribute(this.selected, 'name', e.target.value); // edit the name
        this._renderAfterChange();
      },

      _onTypeChanged: function (evt, el) {

        var type = el.value;
        if(type){
          if(!this.selected.model.get('type').includes(type)){
            if(this.newRel){
              this._deleteRelation(this.newRel.get('id'));
              this.newRel = null;
            }
            var data = this._isType('state', this.selected)? this._getStateFormData(true) : this._getRelationFormData();
            var id = this._updateSelectedType(data);
            this.selected = this._graph.getCell(id).findView(this._paper);
            this.selected.highlight(null, this.highlighter);
          }
        }
      },

      /* for both states and relations */
      _updateSelectedType: function (data) {
        var id;

        if(this._isType('state', this.selected)){
          id = this.addState(data.type, data.name, data.attributes, data.methods, this.selected.model.get('position'));
          this._copyRelationsAll(this.selected.model.get('id'), id, this._findRelations(this.selected.model.get('id')));
          this._deleteState(this.selected.model.get('id'));
        } else{
          id = this.addRelation(data.type, data.source, data.target);
          this._deleteRelation(this.selected.model.get('id'))
        }
        return id;
      },

      _copyRelationsAll: function (oldId, newId, relations) {
        relations.forEach(function (r) {
          if(this._relations[r].relation.source.id === oldId)
            this.addRelation(this._relations[r].type, { id:newId }, this._relations[r].relation.target)
          else
            this.addRelation(this._relations[r].type, this._relations[r].relation.source, { id:newId })
        }.bind(this))
      },

      /* for both states and relations */
      _onAttributeChanged: function (e) {
        var attrs = this._getValuesFromTable(Polymer.dom(e).localTarget.closest('table'));

        this._updateInputTable('attributes', attrs);
      },

      _onAttributeRemoved: function(table){
        var attrs = this._getValuesFromTable(table);

        this._updateInputTable('attributes', attrs);
      },

      _onMethodChanged: function (e) {
        var methods = this._getValuesFromTable(Polymer.dom(e).localTarget.closest('table'));
        methods.forEach(function (m,i) {
          if(!m.startsWith('+'))
            methods[i] = '+ '+m;
        });

        this._updateInputTable('methods', methods);
      },

      _onMethodRemoved: function(table){
        var methods = this._getValuesFromTable(table);
        methods.forEach(function (m,i) {
          if(!m.startsWith('+'))
            methods[i] = '+ '+m;
        });

        this._updateInputTable('methods', methods);
      },

      _updateInputTable: function(key, value){
        this._editAttribute(this.selected, key, value); // edit the attributes
        this._renderAfterChange();
      },

      _getValuesFromTable:function (table) {
        var rows = table.querySelectorAll('paper-input');
        return Array.prototype.slice.call(rows).filter(function(el){
          return !!el.value.trim();
        }).map(function (x) {
          return x.value.trim();
        });
      },

      /* for both states and relations */
      _renderAfterChange: function () {

        if(this._isType('state', this.selected)) {

          this._editAttribute(this.selected, 'size', this._computeJointJsStateSize(this.selected.model.get('name'), this.selected.model.get('attributes'), this.selected.model.get('methods')));
          this.selected.render(); // render state
          // this._renderRelations(this._findRelations(this.selected.model.get('id'))); // render all involved relation
        }

        this.selected.unhighlight(null, this.highlighter);
        this.selected.highlight(null, this.highlighter);
      },

      // _renderRelations: function (relations) {
      //   relations.forEach(function (r) {
      //
      //     var rel = this._graph.getCell(r).findView(this._paper)
      //
      //     try {
      //       // rel.render();
      //     } catch(err) {
      //       // unknow error
      //     }
      //   }.bind(this))
      // },

      /* for both states and relations */
      _saveChanges: function () {
        if(!this._getStateFormData()){
          this._undoChanges();
        } else {
          this.selectedCopy = null;
          this._showNewLinkButton(this.selected);
        }
      },

      /* for both states and relations */
      _undoChanges: function(){

        var data = this._getModelData(this.selectedCopy, this._isType('state', this.selected));

        if (this.selected.model.get('type').includes(data['type'])){
          Object.keys(data).forEach(function (key) {
            if(key !== 'type')
              this._editAttribute(this.selected, key, data[key]);
          }.bind(this));
          this._renderAfterChange();
        } else{
          this._updateSelectedType(data);
        }
        this.selectedCopy = null;
      },

      /* for both states and relations */
      _editAttribute: function (selected, key, value) {
        selected.model.set(key, value);

        if(this._isType('state', selected))
          this._states[selected.model.id].state[key] = value;
        else
          this._relations[selected.model.id].relation[key] = value;
      },

      /* for both states and relations */
      _getModelData: function (model, isState) {
        if (isState)
          return {
            name: model.name,
            type: this._getModelSubType(model,isState),
            attributes: model.attributes,
            methods: model.methods
          };
        else
          return {
            type: this._getModelSubType(model,isState),
            source: model.source,
            target: model.target
          }
      },

      /* for both states and relations */
      _getModelSubType: function (model, isState) {
        var type,
          collection = isState? this._types.states: this._types.relations;

        collection.forEach(function (value) {
          type = model.type.includes(value)? value : type;
        });
        return type;
      },

      /**
       * Relation edit
       */

      /* Called when a link is changed (after 'change.z' event in 'joint.dia') */
      _onRelationTargetOrSourceChanged: function (rel) {
        this._relations[rel.id].relation.source = rel.attributes.source;
        this._relations[rel.id].relation.target = rel.attributes.target;
      },

      _changeRelationSourceAndTarget: function (evt, el) {
        var type = evt.target.id;

        if(el.value){
          if(this.selected.model.get(type).id !== el.value.id){
            this._editAttribute(this.selected, type, { id:el.value.id });
            this._renderAfterChange();
          }
        }
      },

      _updateNewRelTargetPosition: function () {
        if(this.newRel){
          this._deleteRelation(this.newRel.get('id'));
          this.newRel = null;

          this._showNewLinkButton(this.selected);
        }
      },

      /**
       * Cells selection
       */

      _selectJointjsObject: function (cellView, evt, x, y) {

        var id = cellView.model.id;
        if(this._states[id] || (this._relations[id] && evt.type === 'mousedown')){ // click on state or on relation 'options' icon
          if(!this.multiModeEnabled){
            if(this.selectedElements.length > 0) {
              this._multiDeselectAll();
            }

            this._singleSelect(cellView);

          } else{
            if(!this.selected && this.selectedElements.length === 0){ // both emptys
              this._singleSelect(cellView);
            }
            else if(this.selected && this.selectedElements.length === 0){ // not empty and empty
              if(this.selected.model.id === cellView.model.get('id')){
                this._onJointjsObjDeselected();
              }
              else{
                var s = this.selected;
                this._onJointjsObjDeselected();
                this._multiSelect(s);
                this._multiSelect(cellView);
              }
            } else if(!this.selected && this.selectedElements.length > 0){ // empty and not empty
              this._multiSelect(cellView);
            }
          }
        }
      },

      _singleSelect: function(cellView){
        if(this.selected){
          if(this.selected.model.id === cellView.model.get('id'))
            return;
          else
            this._onJointjsObjDeselected();
        }
        this.selected = cellView;
        this.selectedCopy = this._cloneSelected(); // keep a copy in case of 'undo' operation
        this.selected.highlight(null, this.highlighter);
        this.selectedCounter++;
        this._showNewLinkButton(cellView);
      },

      _cloneSelected: function(){
        return _.cloneDeep(this.selected.model.attributes)
      },

      _multiSelect: function(cellView){
        if(this._isSelected(cellView)){
          this._multiDeselect(cellView);
          if(this.selectedCounter === 1){ // only one element, switch to single mode
            this._singleSelect(this.selectedElements[0]);
            this.selectedCounter=1;
            this.selectedElements = [];
          }
        }
        else {
          this.selectedElements.push(cellView);
          cellView.highlight(null, this.highlighter);
          this.selectedCounter++;
        }
      },

      _isSelected: function (cellView) {
        for(var i=0;i<this.selectedElements.length;i++){
          if(this.selectedElements[i].model.get('id') === cellView.model.get('id'))
            return true;
        }
        return false;
      },

      /**
       * Cells de-selection
       */

      _onClearButtonClicked: function (evt) {
        this._deselectJointjsObj();
      },

      _deselectJointjsObj: function (cell) {
        if(this.selectedCounter !== 0){
          if(cell && cell.model && this.selected && this.newRel){
            if(this._isNewRelation(cell.model))
              return;
          }
          this._onJointjsObjDeselected();
          this._multiDeselectAll();
        }
      },

      _isNewRelation: function (model) {
        return model.get('id') === this.newRel.get('id');
      },

      _onJointjsObjDeselected: function () {
        var cell = this.selected;
        if(cell) {
          if(this.selectedCopy){
            this._undoChanges();
          }
          this.selected.unhighlight(null, this.highlighter);
          if(this.newRel){
            this._deleteRelation(this.newRel.get('id'));
            this.newRel = null;
          }
          this.selected = null;
          this._showStateContent = false;
          this._showLinkContent = false;
          this._showEditContent = true;
          this.selectedCounter--;
        }
        return cell;
      },

      _multiDeselect:function (cellView) {
        for(var i=0;i<this.selectedElements.length;i++){
          if(this.selectedElements[i].model.get('id') === cellView.model.get('id')) {
            this.selectedElements[i].unhighlight(null, this.highlighter);
            this.selectedElements.splice(i, 1);
            this.selectedCounter--;
            return;
          }
        }
      },

      _multiDeselectAll:function () {
        for(var i=0;i<this.selectedElements.length;i++){
          this.selectedElements[i].unhighlight(null, this.highlighter);
        }
        this.selectedElements = [];
        this.selectedCounter=0;
      },

      /**
       * State deletion
       */

      _deleteState: function (id) {
        var rel = this._findRelations(id), t = this;

        rel.forEach(function (r) {
          t._deleteFromRelationsDict(r) // remove involved relations from relations Dictionary
        });

        this._deleteCellFromGraph(this._states[id].cid); // remove state from graph (and also involved relations)
        this._deleteFromStatesDict(id); // remove state from states Dictionary
      },

      /* for both states and relations */
      _deleteSelected: function (){
        if(this.selected) {
          var sel = this._onJointjsObjDeselected();
          this._singleDelete(sel);

        } else if(this.selectedCounter > 1){
          this._multiDelete();
        }
      },

      _singleDelete:function (cell) {
        if (this._isType('state', cell))
          this._deleteState(cell.model.get('id'))
        else
          this._deleteRelation(cell.model.get('id'))
      },

      _multiDelete: function () {

        this.selectedElements.forEach(function(el){
          this._singleDelete(el);
        }.bind(this))
        this.selectedElements = [];
        this.selectedCounter = 0;
      },

      _deleteFromStatesDict: function (id) {
        delete this._states[id];
      },

      _deleteCellFromGraph: function (cid) {
        this._graph.getCell(cid).remove(); // works for both states and relations (also delete elements from 'svg')
      },

      /**
       * Relation deletion
       */

      _deleteRelation: function (id) {
        if (this._relations[id]) {
          this._deleteCellFromGraph(this._relations[id].cid); // remove cell from graph
          this._deleteFromRelationsDict(id);
        }
      },

      /* Called when a link is deleted (after 'remove' event in 'joint.dia') */
      _onRelationDeleted: function (rel) {
        if(this.selected && rel.id === this.selected.model.get('id')){
          this.selectedCopy = null;
        }
        // this._onJointjsObjDeselected();
        this._deleteFromRelationsDict(rel.id);
      },

      _deleteFromRelationsDict: function (id) {
        delete this._relations[id];
      },

      /**
       * Helper functions
       */

      showStateErrorMessage: function (el, type,name) {
        if (!type){
          this.showError(el, '- please choose a type');
          return true;
        }
        else if (!name){
          this.showError(el, '- please enter a name');
          return true;
        }
        return false;
      },

      showRelationErrorMessage: function (el, type, source, target){
        if (!type){
          this.showError(el, '- please choose a type');
          return true;
        }
        else if (!source){
          this.showError(el, '- please choose the source');
          return true;
        }
        else if (!target){
          this.showError(el, '- please choose the target');
          return true;
        }
        else if (source.id === target.id){
          this.showError(el, '- source and target are the same');
          return true;
        }
        return false;
      },

      showError: function (el, text) {
        var err = el.querySelector('div[id=error]');
        err.style = 'visibility:visible';
        err.querySelector('p[id=whichError]').innerHTML = text;
        setTimeout(function(){
          err.removeAttribute('style');
        }, 2000);
      },

      _findRelations: function (id) {
        var rel = [], relations = this._relations;
        Object.keys(this._relations).forEach(function (r) {
          if (relations[r].relation.source.id === id || relations[r].relation.target.id === id)
            rel.push(r);
        });
        return rel;
      },

      _computeSize: function () {
        var h = this.height;
        var w = this.width;
        this.$['app-body'].style = 'height:' + h + 'px;' + 'width:' + (w + 10) + 'px;';
        this.$['paper-container'].style = 'height:' + h + 'px;' + 'width:' + w + 'px;';
        this.$['sidebar'].style.height = h+'px';
      },

      _computeJointJsStateSize: function (name, attributes, methods) {
        var arr = [name].concat(attributes, methods);
        return {
          width: this._computeStateWidth(arr) + 2, // + 2 for margins
          height: Math.max(50, 2 * 15 + (arr.length) * 12)
        }
      },

      _computeStateWidth: function (arr) {
        var w = 0;
        for (var i = 0; i < arr.length; i++) {
          w = Math.max(w, this._getWidthOfText(arr[i], (i===0)))
        }
        return Math.max(Math.max(w),100);
      },

      _getWidthOfText: function (txt, bold) {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        ctx.font = bold ? '12.5px Courier' : '10.4px Courier';
        return ctx.measureText(txt).width;
      },

      _addRow: function (e) {
        var table = e.target.parentElement.parentElement.querySelector('table'), row = table.insertRow(table.rows.length);
        row.insertCell(0).appendChild(document.createTextNode(table.rows.length+":"));

        var input = document.createElement('paper-input'),
          icon = document.createElement('iron-icon');
        icon.icon = "remove-circle";
        icon.setAttribute('suffix','true');
        input.appendChild(icon);
        row.insertCell(1).appendChild(input);

        this.listen(row.querySelector('iron-icon'),'click','_removeRow');

        if(e.target.hasAttribute('edit')){
          if(e.target.getAttribute('edit') === 'methods')
            this.listen(row.querySelector('paper-input'),'input','_onMethodChanged');
          else
            this.listen(row.querySelector('paper-input'),'input','_onAttributeChanged');
        }
      },

      _removeRow: function (e) {
        var table = Polymer.dom(e).localTarget.closest('table');
        Polymer.dom(e).localTarget.closest('tr').remove();
        this.fixLabels(table);

        if(table.hasAttribute('edit'))
          this._onRowRemoved(table);
      },

      _onRowRemoved: function(table){
        table.getAttribute('edit') === 'methods'? this._onMethodRemoved(table): this._onAttributeRemoved(table);
      },

      fixLabels: function(table) {
        for (var i = 0; i < table.rows.length; i++) {
          table.rows[i].querySelector('td').innerHTML = (i + 1) + ':';
        }
      },

      _getIcon: function (show) {
        return show ? 'remove-circle' : 'add-circle';
      },

      _mapToArrayOfObjects: function(obj){
        return Object.keys(obj).map(function(key) {
          return {id: key, text: obj[key].state.name};
        });
      },

      _getKeys: function(obj){
        return Object.keys(obj);
      },

      _isType: function(type, selected){
        if(selected){
          if(this._states[selected.model.id])
            return type === 'state';
          else
            return type === 'relation';
        }
        return false;
      },

      _getIndexOfItem: function (item, array) {
        if(item){
          if(!Array.isArray(array))
            array = this._getKeys(array);
          for(var i = 0; i < array.length; i++){
            if(item.includes(array[i]))
              return i;
          }
        }
      },

      _inc: function(index){
        return index+1;
      },

      _keyHandler: function (evt) {
        if(evt.key === 'Meta') {
          if (evt.type === 'keydown') this.multiModeEnabled = true;
          else if (evt.type === 'keyup') this.multiModeEnabled = false;
        }
      }

    });
  </script>

</dom-module>
