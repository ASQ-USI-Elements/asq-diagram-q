<link rel="import" href="../../../iron-icon/iron-icon.html">
<link rel="import" href="../../../iron-icons/iron-icons.html">
<link rel="import" href="../../../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../../../paper-button/paper-button.html">
<link rel="import" href="../../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../paper-listbox/paper-listbox.html">
<link rel="import" href="../../../paper-item/paper-item.html">
<link rel="import" href="../../../paper-input/paper-input.html">

<!--
`asq-diagram-q-viewer-erd` is use to show to the viewer.

@element asq-diagram-q-viewer-erd
@demo demo/index.html
@group ASQ Elements
@blurb Element acting as an editor for diagram questions.
@homepage http://github.com/ASQ-USI-Elements/asq-diagram-q
-->
<dom-module id='asq-diagram-q-viewer-erd'>

  <template>
    <style include='asq-diagram-q-shared-styles'>
      .link-tools .tool-options {
        display: block; /* by default is 'none' but we want to use it */
      }
    </style>

    <div id="app-body">
      <div id="sidebar" class="open">
        <div id="sidebar-content">
          <template is="dom-if" if="{{_nothingSelected(selectedCounter)}}" restamp>
            <div class="menu state">
              <div class="expand-button">
                <paper-button raised on-click="_expandStateMenu"><iron-icon icon="{{_getIcon(_showStateContent)}}"></iron-icon><h4 class="button-label">NEW STATE</h4></paper-button>
              </div>
              <template is="dom-if" if="{{_showStateContent}}" restamp>
                <div class="menu-content">
                  <iron-label class="group-label"><span>Entities</span></iron-label>
                  <div class="menu-element entities" id="buttons">
                    <paper-button class="newERDBtn" create="Entity" raised on-click="newERDState"><div><img src="../../img/erd/entity.png" height="100%" width="100%"></div><div></div></paper-button>
                    <paper-button class="newERDBtn" create="Weak Entity" raised on-click="newERDState"><div><img src="../../img/erd/weakEntity.png" height="100%" width="100%"></div><div></div></paper-button>
                  </div>
                  <iron-label class="group-label"><span>Relationships</span></iron-label>
                  <div class="menu-element relationships" id="buttons">
                    <paper-button class="newERDBtn" create="Relationship" raised on-click="newERDState"><div><img src="../../img/erd/relationship.png" height="100%" width="100%"></div><div></div></paper-button>
                    <paper-button class="newERDBtn" create="Identifying Relationship" raised on-click="newERDState"><div><img src="../../img/erd/identifyingRelationship.png" height="100%" width="100%"></div><div></div></paper-button>
                    <paper-button class="newERDBtn" create="ISA" raised on-click="newERDState"><div><img src="../../img/erd/isa.png" height="100%" width="100%"></div><div></div></paper-button>
                  </div>
                  <iron-label class="group-label"><span>Attributes</span></iron-label>
                  <div class="menu-element attributes" id="buttons">
                    <paper-button class="newERDBtn" create="Attribute" raised on-click="newERDState"><div><img src="../../img/erd/attribute.png" height="100%" width="100%"></div><div></div></paper-button>
                    <paper-button class="newERDBtn" create="Key" raised on-click="newERDState"><div><img src="../../img/erd/key.png" height="100%" width="100%"></div><div></div></paper-button>
                    <paper-button class="newERDBtn" create="Multivalued" raised on-click="newERDState"><div><img src="../../img/erd/multivalued.png" height="100%" width="100%"></div><div></div></paper-button>
                    <paper-button class="newERDBtn" create="Derived" raised on-click="newERDState"><div><img src="../../img/erd/derived.png" height="100%" width="100%"></div><div></div></paper-button>
                  </div>
                </div>
              </template>
            </div>
            <div class="menu link">
              <div class="expand-button">
                <paper-button raised on-click="_expandRelationMenu"><iron-icon icon="{{_getIcon(_showLinkContent)}}"></iron-icon><h4 class="button-label">CONNECT</h4></paper-button>
              </div>
              <template is="dom-if" if="{{_showLinkContent}}" restamp>
                <div class="menu-content">
                  <div class="menu-element" id="source">
                    <paper-dropdown-menu class="drop-down" label="Source" horizontal-align="left" on-opened-changed="setHeight">
                      <paper-listbox class="dropdown-content">
                        <template is="dom-repeat" items="{{_mapToArrayOfObjects(_states)}}">
                          <paper-item id="{{item.id}}">{{item.text}}</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>
                    <div id="label">
                      <iron-label>
                        <span>Label</span>
                      </iron-label>
                      <paper-input></paper-input>
                    </div>
                  </div>
                  <div class="menu-element" id="target">
                    <paper-dropdown-menu class="drop-down" label="Target" horizontal-align="left" on-opened-changed="setHeight">
                      <paper-listbox class="dropdown-content">
                        <template is="dom-repeat" items="{{_mapToArrayOfObjects(_states)}}">
                          <paper-item id="{{item.id}}">{{item.text}}</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>
                    <div id="label">
                      <iron-label>
                        <span>Label</span>
                      </iron-label>
                      <paper-input></paper-input>
                    </div>
                  </div>
                  <div class="menu-element error-message" id="error">
                    <p>Submission not valid:</p>
                    <p id="whichError">- error message -</p>
                  </div>
                  <div class="menu-element" id="buttons">
                    <paper-button raised on-click="newERDRelation"><div><iron-icon icon="note-add"></iron-icon></div><div><h4 class="button-label">CONNECT</h4></div></paper-button>
                    <paper-button raised on-click="_expandRelationMenu"><div><iron-icon icon="block"></iron-icon></div><div><h4 class="button-label">CLEAR</h4></div></paper-button>
                  </div>
                </div>
              </template>
            </div>
          </template>
          <template is="dom-if" if="{{_somethingSelected(selectedCounter)}}" restamp>
            <div class="menu edit">
              <div class="expand-button">
                <paper-button raised on-click="_expandEditMenu"><iron-icon icon="{{_getIcon(_showEditContent)}}"></iron-icon><h4 class="button-label">EDIT</h4></paper-button>
              </div>
              <div class="menu-content">
                <template is="dom-if" if="{{_showEditContent}}" restamp>
                  <template is="dom-if" if="{{_oneSelected(selectedCounter)}}" restamp>
                    <template is="dom-if" if="{{_isType('state', selected)}}" restamp>
                      <!--type-->
                      <div class="menu-element" id="type">
                        <paper-dropdown-menu class="drop-down" label="Type" horizontal-align="left" on-value-changed="_onTypeChanged" on-opened-changed="setHeight">
                          <paper-listbox class="dropdown-content" selected="{{_getIndexOfItemType(selected.model.attributes.type, _shapes.states)}}">
                            <paper-item disabled><p class="inner-label">Entities</p></paper-item>
                            <template is="dom-repeat" items="{{_shapes.states.entities}}" restamp>
                              <paper-item>[[item]]</paper-item>
                            </template>
                            <paper-item disabled><p class="inner-label">Relationships</p></paper-item>
                            <template is="dom-repeat" items="{{_shapes.states.relationships}}" restamp>
                              <paper-item>[[item]]</paper-item>
                            </template>
                            <paper-item disabled><p class="inner-label">Attributes</p></paper-item>
                            <template is="dom-repeat" items="{{_shapes.states.attributes}}" restamp>
                              <paper-item>[[item]]</paper-item>
                            </template>
                          </paper-listbox>
                        </paper-dropdown-menu>
                      </div>
                      <!--label-->
                      <template is="dom-if" if="{{_not_ISA_Relationship(selected.model.attributes.type)}}" restamp>
                        <div class="menu-element" id="label">
                          <iron-label>
                            <span>Label</span>
                          </iron-label>
                          <paper-input value="{{getStateLabel(selected)}}" on-input="_onStateLabelChanged"></paper-input>
                        </div>
                      </template>
                    </template>

                    <template is="dom-if" if="{{_isType('relation', selected)}}" restamp>
                      <div class="menu-element" id="source">
                        <paper-dropdown-menu class="drop-down" label="Source" horizontal-align="left" on-selected-item-changed="_changeRelationSourceAndTarget" on-opened-changed="setHeight">
                          <paper-listbox class="dropdown-content" selected="{{_getIndexOfItemRel(selected.model.attributes.source.id, _states)}}">
                            <template is="dom-repeat" items="{{_mapToArrayOfObjects(_states)}}">
                              <paper-item id="[[item.id]]">[[item.text]]</paper-item>
                            </template>
                          </paper-listbox>
                        </paper-dropdown-menu>
                        <div id="label">
                          <iron-label>
                            <span>Label</span>
                          </iron-label>
                          <paper-input id="sLabel" value="{{getRelationLabel(selected, 'source')}}" on-input="_onRelationLabelChanged"></paper-input>
                        </div>
                      </div>
                      <div class="menu-element" id="target">
                        <paper-dropdown-menu class="drop-down" label="Target" horizontal-align="left" on-selected-item-changed="_changeRelationSourceAndTarget" on-opened-changed="setHeight">
                          <paper-listbox class="dropdown-content" selected="{{_getIndexOfItemRel(selected.model.attributes.target.id, _states)}}">
                            <template is="dom-repeat" items="{{_mapToArrayOfObjects(_states)}}">
                              <paper-item id="[[item.id]]">[[item.text]]</paper-item>
                            </template>
                          </paper-listbox>
                        </paper-dropdown-menu>
                        <div id="label">
                          <iron-label>
                            <span>Label</span>
                          </iron-label>
                          <paper-input id="tLabel" value="{{getRelationLabel(selected, 'target')}}" on-input="_onRelationLabelChanged"></paper-input>
                        </div>
                      </div>
                    </template>
                    <!--error-->
                    <div class="menu-element error-message" id="error">
                      <p>Submission not valid:</p>
                      <p id="whichError">- error message -</p>
                    </div>
                    <!--Buttons-->
                    <div class="menu-element" id="buttons">
                      <paper-button raised on-click="_saveChanges"><div><iron-icon icon="save"></iron-icon></div><div><h4 class="button-label">SAVE</h4></div></paper-button>
                      <template is="dom-if" if="{{_isType('state', selected)}}" restamp>
                        <paper-button raised on-click="_onJointjsObjDeselected"><div><iron-icon icon="content-copy"></iron-icon></div><div><h4 class="button-label">CLONE</h4></div></paper-button>
                      </template>
                      <paper-button raised on-click="_onClearButtonClicked"><div><iron-icon icon="block"></iron-icon></div><div><h4 class="button-label">CLEAR</h4></div></paper-button>
                      <paper-button raised on-click="_deleteSelected"><div><iron-icon icon="delete"></iron-icon></div><div><h4 class="button-label">DELETE</h4></div></paper-button>
                    </div>
                  </template>
                  <template is="dom-if" if="{{_twoSelected(selectedCounter)}}" restamp>
                    <div class="menu-element" id="buttons">
                      <paper-button raised on-click="_connectSelected"><div><iron-icon icon="link"></iron-icon></div><div><h4 class="button-label">CONNECT</h4></div></paper-button>
                      <paper-button raised on-click="_onClearButtonClicked"><div><iron-icon icon="block"></iron-icon></div><div><h4 class="button-label">CLEAR</h4></div></paper-button>
                      <paper-button raised on-click="_deleteSelected"><div><iron-icon icon="delete"></iron-icon></div><div><h4 class="button-label">DELETE</h4></div></paper-button>
                    </div>
                  </template>
                  <template is="dom-if" if="{{_multipleSelected(selectedCounter)}}" restamp>
                    <div class="menu-element" id="buttons">
                      <paper-button raised on-click="_onClearButtonClicked"><div><iron-icon icon="block"></iron-icon></div><div><h4 class="button-label">CLEAR</h4></div></paper-button>
                      <paper-button raised on-click="_deleteSelected"><div><iron-icon icon="delete"></iron-icon></div><div><h4 class="button-label">DELETE</h4></div></paper-button>
                    </div>
                  </template>
                </template>
              </div>
            </div>
          </template>
          <div id="zoom">
            <paper-icon-button icon="zoom-in" on-click="zoomIn"></paper-icon-button>
            <p id="scale-label">{{getScale(_scale)}}</p>
            <paper-icon-button icon="zoom-out" on-click="zoomOut"></paper-icon-button>
          </div>
        </div>
        <div id="sidebar-button"><paper-icon-button icon="chevron-left" on-click="_expandOrCollapse"></paper-icon-button></div>
      </div>
      <div id='paper-container'>
        <div id='paper'></div>
      </div>

    </div>

  </template>

  <script>
    Polymer({
      is: 'asq-diagram-q-viewer-erd',

      behaviors: [
        ASQ.asqQuestionElementBehavior,
        ASQDiagramQBehavior
      ],

      listeners: {},

      hostAttributes: {},

      properties: {
        /**
         * width in pixels of the diagram
         */
        width: {
          type: Number,
          value: 600,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * height in pixels of the diagram
         */
        height: {
          type: Number,
          value: 600,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The grap object
         *  @type {Object}
         */
        _graph: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The paper object
         *  @type {Object}
         */
        _paper: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        _scale: {
          type: Number,
          value: 1,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The uml object
         *  @type {Object}
         */
        _erd: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Obj containing subtypes for every supported type
         */
        _shapes: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Object containing all created states
         *  @type {Object}
         */
        _states: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Object containing all created relations
         *  @type {Object}
         */
        _relations: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The selected state/relation
         */
        selected: {
          type: Object,
          value: null,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The selected state/relation copy for undo operation
         */
        selectedCopy: {
          type: Object,
          value: null,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The selected state
         */
        multiModeEnabled: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Array of selected cells
         */
        selectedElements: {
          type: Array,
          value: [],
          notify: true,
          reflectToAttribute: true
        },

        /**
         * True is multiple elements are selected
         */
        selectedCounter:{
          type: Number,
          value: 0,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * The style of cell highlighter
         */
        highlighter: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        _showStateContent:{
          type: Boolean,
          value:false,
          notify: true,
          reflectToAttribute: true
        },

        _showLinkContent:{
          type: Boolean,
          value:false,
          notify: true,
          reflectToAttribute: true
        },

        _showEditContent:{
          type: Boolean,
          value:true,
          notify: true,
          reflectToAttribute: true
        }
      },

      attached: function () {
        this.async(function () {
          this.init();
        });
      },
      /**
       * set up phase
       */
      init: function () {
        this._graph = new joint.dia.Graph();
        this._paper = new joint.dia.Paper({
          el: this.$.paper,
          width: 1920,
          height: 1920,
          model: this._graph,
          gridSize: 10,
          drawGrid:true
        });
        this._computeViewerSize(this.height, this.width);
        this._erd = joint.shapes.erd;
        this._shapes = this._getShapes('erd');
        this._states = {};
        this._relations = {};
        this.selectedElements = [];

        this._setJointJsEventListeners();
        this._setCellHighlighter();
        this._setKeyAndMouseEventListeners();
      },

      /**
       * expand/collapse sidebar
       */
      _expandOrCollapse: function () {
        if(this.$['sidebar'].className === "open")
          this._collapseSidebar();
        else
          this._expandSidebar();
      },

      /**
       * expand/collapse menu
       */
      _expandStateMenu: function () {
        this._showStateContent = !this._showStateContent
      },

      _not_ISA_Relationship: function(type){
        return type && !type.includes("ISA");
      },

      _expandRelationMenu: function () {
        this._showLinkContent = !this._showLinkContent
      },

      _expandEditMenu: function () {
        this._showEditContent = !this._showEditContent
      },

      _nothingSelected: function (counter) {
        return counter === 0;
      },

      _somethingSelected: function (counter) {
        return counter > 0;
      },

      _oneSelected: function(counter){
        return counter === 1;
      },

      _twoSelected: function(counter){
        return counter === 2 && this.selectedElements.every(function (el) {
          return this._isType('state',el);
        }.bind(this))
      },

      _multipleSelected: function(counter){
        return counter > 1 && !this._twoSelected(counter);
      },

      /**
       * State creation
       */

      newERDState: function (e) {
        var type = Polymer.dom(e).localTarget.closest('paper-button').getAttribute('create');

        var position = this._getNewStatePosition(this);
        var id = this.addState(type, position);

        this._singleSelect(this._graph.getCell(id).findView(this._paper));
      },

      _getStateFormData: function (typeChange) {
        var el = this.$$('div[class="menu edit"] div[class=menu-content]');

        var type = el.querySelector('div[id=type] paper-dropdown-menu').value;
        var label;
        if(this._not_ISA_Relationship(type)){
          label = el.querySelector('div[id=label] paper-input');
          label = label? label.value : "\"Label\"";
        }

        if(!typeChange) {
          if (this._showERDStateErrorMessage(el, type, label))
            return;
        }
        return { type:type, label:label}
      },

      addState: function (type, position, optionalLabel) {
        var state = { position: position };
        var label = optionalLabel || "\"Label\"";
        var s = this._createState(type, label, state);

        this._graph.addCell(s);
        this._states[s.id] = { type:type, cid:s.cid, label:label, state:state };

        s.on('change:position', this._onStatePositionChanged.bind(this)); // for handling position changes
        return s.id;
      },

      _createState: function (type, label, state) {
        var s = _.cloneDeep(state);
        s.attrs = this._getERDAttrs(type, label);

        if (type === 'Entity')
          return new this._erd.Entity(s);
        else if (type === 'Weak Entity')
          return new this._erd.WeakEntity(s);
        else if (type === 'Relationship')
          return new this._erd.Relationship(s);
        else if (type === 'Identifying Relationship')
          return new this._erd.IdentifyingRelationship(s);
        else if (type === 'ISA')
          return new this._erd.ISA(s);
        else if (type === 'Attribute')
          return new this._erd.Normal(s);
        else if (type === 'Key')
          return new this._erd.Key(s);
        else if (type === 'Multivalued')
          return new this._erd.Multivalued(s);
        else if (type === 'Derived')
          return new this._erd.Derived(s);
      },

      /**
       * Relation creation
       */

      newERDRelation: function() {
        var data = this._getRelationFormData();
        if(!data) return;

        this.addRelation(data.source, data.target, data.sLabel, data.tLabel);
        this._expandRelationMenu();
      },

      _getRelationFormData: function () {
        var el = this.$$('div[class="menu link"] div[class=menu-content]') || this.$$('div[class="menu edit"] div[class=menu-content]');

        var source = el.querySelector('div[id=source] paper-dropdown-menu').selectedItem;
        var sLabel = el.querySelector('div[id=source] div[id=label] paper-input').value;
        var target = el.querySelector('div[id=target] paper-dropdown-menu').selectedItem;
        var tLabel = el.querySelector('div[id=target] div[id=label] paper-input').value;

        if (this._showRelationErrorMessage(el, source, target)) return;
        return { source: {id: source.id}, sLabel:sLabel, target: {id: target.id }, tLabel:tLabel}
      },

      addRelation: function (source, target, sLabel, tLabel) {
        var relation = this._relationPropertiesToJSONObj(source, target);

        var r = this._createRelation(relation).set(this._createLabels(sLabel,tLabel));
        this._graph.addCell(r);
        this._relations[r.id] = {'cid': r.cid, 'relation': relation, labels: {sLabel:sLabel, tLabel:tLabel}};

        r.on('change:z', this._onRelationTargetOrSourceChanged.bind(this)); // handle source/target modifications
        r.on('remove', this._onRelationDeleted.bind(this)); // handle link deletion
        return r.id;
      },

      _createRelation: function (relation) {
          return new this._erd.Line(relation);
      },

      _connectSelected: function () {
        var source = this.selectedElements[0].model.get('id');
        var target = this.selectedElements[1].model.get('id');

        this._multiDeselectAll();
        var id = this.addRelation({ id: source }, { id: target });
        this._singleSelect(this._graph.getCell(id).findView(this._paper));
      },

      _showNewLinkButton: function(state){
        if(this._isType('state', state) && !this.newRel){

          var pos = this._getNewLinkPosition(state);
          var attr = this._getNewRelAttrs();
          var id = this.addRelation(pos.source,pos.target);

          this.newRel = this._graph.getCell(id);
          this.newRel.attr(attr);
          this.newRel.on('change:target', this._saveNewLink.bind(this));
        }
      },

      _hideNewLinkButton: function(){
        if(this.newRel)
          this._deleteRelation(this.newRel.get('id'),true);
      },

      _saveNewLink: function (cell,val) {
        if(this.newRel) {
          var rel = this.newRel;
          this.newRel = null;
          this._deselectJointjsObj();
          delete rel.attributes.attrs;
          rel.findView(this._paper).render();
        }
        if(val.id){
          this._singleSelect(cell.findView(this._paper));
        }
      },

      /**
       * State edit
       */

      _onStatePositionChanged: function (state, pos) {
        this._states[state.id].state.position = pos;
        if(this.selected && this.selected.model.get('id')===state.id){
         this._updateNewRelTargetPosition();
        }
        else if(this.selected && this.selected.model.attributes.source)
          this._onJointjsObjDeselected();
      },

      _onStateLabelChanged: function(e){
        this.selected.model.attr('text/text',e.target.value)
        this._states[this.selected.model.id].label = e.target.value
        this._hideNewLinkButton()
      },

      _onTypeChanged: function (evt, el) {

        var newType = el.value;
        var oldType = this.selected.model.get('type').includes("Normal")? "Attribute" : this.selected.model.get('type');
        if(newType){
          if(oldType.toLowerCase().replace(/erd./g, '') !== newType.toLowerCase().replace(/\s/g, '')){
            this._hideNewLinkButton();
            var data = this._isType('state', this.selected)? this._getStateFormData(true) : this._getRelationFormData();
            var id = this._updateSelectedType(data);
            this.selected = this._graph.getCell(id).findView(this._paper);
            this.selected.highlight(null, this.highlighter);
          }
        }
      },

      _updateSelectedType: function (data) {
        var id;
        if(this._isType('state', this.selected)){
          id = this.addState(data.type, this.selected.model.get('position'), data.label);
          this._copyRelationsAll(this.selected.model.get('id'), id);
          this._deleteState(this.selected.model.get('id'));
        } else{
          id = this.addRelation(data.source, data.target, data.sLabel, data.tLabel);
          this._deleteRelation(this.selected.model.get('id'))
        }
        return id;
      },

      _copyRelationsAll: function (oldId, newId) {
        var relations = this._findRelations(this.selected.model.get('id'), this._relations);

        relations.forEach(function (r) {
          if(this._relations[r].relation.source.id === oldId)
            this.addRelation({ id:newId }, this._relations[r].relation.target, this._relations[r].labels.sLabel, this._relations[r].labels.tLabel);
          else
            this.addRelation(this._relations[r].relation.source, { id:newId }, this._relations[r].labels.sLabel, this._relations[r].labels.tLabel)
        }.bind(this))
      },

      /* for both states and relations */
      _renderAfterChange: function () {
        this.selected.render();
        this.selected.unhighlight(null, this.highlighter);
        this.selected.highlight(null, this.highlighter);
      },

      /* for both states and relations */
      _saveChanges: function () {
        var data = this._isType('state', this.selected)? this._getStateFormData() : this._getRelationFormData();
        if(data){
          this.selectedCopy = null;
          this._showNewLinkButton(this.selected);
        }
      },

      /* for both states and relations */
      _undoChanges: function(){
        var data = this._getERDModelData(this.selectedCopy, this._isType('state', this.selected));
        if(this._isType('state', this.selected)){
          var newType = this.selected.model.get('type').includes('Normal')? 'Attribute' : this.selected.model.get('type');
          if(newType.toLowerCase().replace(/erd./g, '') === (data.type.toLowerCase().replace(/\s/g, ''))){
            if(this._not_ISA_Relationship(newType)){
              this.selected.model.attr('text/text',data.label);
              this._states[this.selected.model.id].label = data.label;
            }
          } else {
            this._updateSelectedType(data);
          }
        }
        else {
          this.selected.model.set('source', data.source);
          this.selected.model.set('target', data.target);

          this._setSourceLabel(data.sLabel);
          this._setTargetLabel(data.tLabel);
          this._renderAfterChange();
        }
        this.selectedCopy = null;
      },

      /* for both states and relations */
      _editAttribute: function (selected, key, value) {
        selected.model.set(key, value);

        if(this._isType('state', selected))
          this._states[selected.model.id].state[key] = value;
        else
          this._relations[selected.model.id].relation[key] = value;
      },

      /**
       * Relation edit
       */
      /* Called when a link is changed (after 'change.z' event in 'joint.dia') */
      _onRelationTargetOrSourceChanged: function (rel) {
        this._relations[rel.id].relation.source = rel.attributes.source;
        this._relations[rel.id].relation.target = rel.attributes.target;
      },

      _changeRelationSourceAndTarget: function (evt, el) {
        var type = evt.target.parentElement.id;
        if(el.value){
          if(this.selected.model.get(type).id !== el.value.id){
            this._editAttribute(this.selected, type, { id:el.value.id });
            this._renderAfterChange();
          }
        }
      },

      _onRelationLabelChanged: function (e) {

        var pInput = e.target;
        if(pInput){
          if(pInput.id === "sLabel"){
            this._setSourceLabel(pInput.value);
          } else if(pInput.id === "tLabel"){
            this._setTargetLabel(pInput.value);
          }
          this._renderAfterChange();
        }
      },

      _setSourceLabel: function(value){
        this.selected.model.attributes.labels[0].attrs.text.text = value;
        this._relations[this.selected.model.id].labels.sLabel = value;
      },

      _setTargetLabel: function(value){
        this.selected.model.attributes.labels[1].attrs.text.text = value;
        this._relations[this.selected.model.id].labels.tLabel = value;
      },

      _updateNewRelTargetPosition: function () {
        this._hideNewLinkButton();
        this._showNewLinkButton(this.selected);
      },

      /**
       * Cells selection
       */
      _selectJointjsObject: function (cellView, evt, x, y) {
        var id = cellView.model.id;
        if(this._states[id] || (this._relations[id] && evt.type === 'mousedown')){ // click on state or on relation 'options' icon
          if(!this.multiModeEnabled){
            if(this.selectedElements.length > 0) {
              this._multiDeselectAll();
            }

            this._singleSelect(cellView);

          } else{
            if(!this.selected && this.selectedElements.length === 0){ // null and empty
              this._singleSelect(cellView);
            }
            else if(this.selected && this.selectedElements.length === 0){ // not null and empty
              if(this.selected.model.id === cellView.model.get('id')){
                this._onJointjsObjDeselected();
              }
              else{
                var s = this.selected;
                this._onJointjsObjDeselected();
                this._multiSelect(s);
                this._multiSelect(cellView);
              }
            } else if(!this.selected && this.selectedElements.length > 0){ // null and not empty
              this._multiSelect(cellView);
            }
          }
        }
      },

      _singleSelect: function(cellView){
        if(this.selected){
          if(this.selected.model.id === cellView.model.get('id'))
            return;
          else
            this._onJointjsObjDeselected();
        }
        this.selected = cellView;
        this.selectedCopy = _.cloneDeep(this.selected.model.attributes); // keep a copy in case of 'undo' operation
        this.selected.highlight(null, this.highlighter);
        this.selectedCounter++;
        this._showNewLinkButton(cellView);
        this._expandSidebar()
      },

      _multiSelect: function(cellView){
        if(this._isSelected(cellView)){
          this._multiDeselect(cellView);
          if(this.selectedCounter === 1){ // only one element, switch to single mode
            this._singleSelect(this.selectedElements[0]);
            this.selectedCounter=1;
            this.selectedElements = [];
          }
        }
        else {
          this.selectedElements.push(cellView);
          cellView.highlight(null, this.highlighter);
          this.selectedCounter++;
        }
      },

      _isSelected: function (cellView) {
        for(var i=0;i<this.selectedElements.length;i++){
          if(this.selectedElements[i].model.get('id') === cellView.model.get('id'))
            return true;
        }
        return false;
      },

      /**
       * Cells de-selection
       */
      _onClearButtonClicked: function (evt) {
        this._deselectJointjsObj();
      },

      _deselectJointjsObj: function (cell) {
        if(this.selectedCounter !== 0){
          if(cell && cell.model && this.selected && this.newRel){
            if(this._isNewRelation(cell.model))
              return;
          }
          this._onJointjsObjDeselected();
          this._multiDeselectAll();
        }
      },

      _isNewRelation: function (model) {
        return model.get('id') === this.newRel.get('id');
      },

      _onJointjsObjDeselected: function () {
        var cell = this.selected;
        if(cell) {
          if(this.selectedCopy){
            this._undoChanges();
          }
          this.selected.unhighlight(null, this.highlighter);
          this._hideNewLinkButton();
          this.selected = null;
          this._showStateContent = false;
          this._showLinkContent = false;
          this._showEditContent = true;
          this.selectedCounter--;
        }
        return cell;
      },

      _multiDeselect:function (cellView) {
        for(var i=0;i<this.selectedElements.length;i++){
          if(this.selectedElements[i].model.get('id') === cellView.model.get('id')) {
            this.selectedElements[i].unhighlight(null, this.highlighter);
            this.selectedElements.splice(i, 1);
            this.selectedCounter--;
            return;
          }
        }
      },

      _multiDeselectAll:function () {
        for(var i=0;i<this.selectedElements.length;i++){
          this.selectedElements[i].unhighlight(null, this.highlighter);
        }
        this.selectedElements = [];
        this.selectedCounter=0;
      },

      /**
       * State deletion
       */
      _deleteState: function (id) {
        var rel = this._findRelations(id,this._relations), t = this;

        rel.forEach(function (r) {
          t._deleteFromRelationsDict(r) // remove involved relations from relations Dictionary
        });

        this._deleteCellFromGraph(this._states[id].cid); // remove state from graph (and also involved relations)
        this._deleteFromStatesDict(id); // remove state from states Dictionary
      },

      /* for both states and relations */
      _deleteSelected: function (){
        if(this.selected) {
          var sel = this._onJointjsObjDeselected();
          this._singleDelete(sel);

        } else if(this.selectedCounter > 1){
          this._multiDelete();
        }
      },

      _singleDelete:function (cell) {
        if (this._isType('state', cell))
          this._deleteState(cell.model.get('id'))
        else
          this._deleteRelation(cell.model.get('id'))
      },

      _multiDelete: function () {
        this.selectedElements.forEach(function(el){
          this._singleDelete(el);
        }.bind(this));
        this.selectedElements = [];
        this.selectedCounter = 0;
      },

      _deleteFromStatesDict: function (id) {
        delete this._states[id];
      },

      _deleteCellFromGraph: function (cid) {
        this._graph.getCell(cid).remove(); // works for both states and relations (also delete elements from 'svg')
      },

      clear: function() {
        this._graph.clear();
        this._states = {};
        this._relations = {};
      },

      /**
       * Relation deletion
       */
      _deleteRelation: function (id, isNewRel) {
        if (this._relations[id]) {
          this._deleteCellFromGraph(this._relations[id].cid); // remove cell from graph
          this._deleteFromRelationsDict(id);
          if(isNewRel)
            this.newRel = null;
        }
      },

      /* Called when a link is deleted (after 'remove' event in 'joint.dia') */
      _onRelationDeleted: function (rel) {
        if(this.selected && rel.id === this.selected.model.get('id')){
          this.selectedCopy = null;
        }
        // this._onJointjsObjDeselected();
        this._deleteFromRelationsDict(rel.id);
      },

      _deleteFromRelationsDict: function (id) {
        delete this._relations[id];
      },

      /**
       * Helper functions
       */

      _getIcon: function (show) {
        return show ? 'remove-circle' : 'add-circle';
      },

      _mapToArrayOfObjects: function(obj){
        return Object.keys(obj).map(function(key) {
          return {id: key, text: obj[key].label};
        });
      },

      _getKeys: function(obj){
        return Object.keys(obj);
      },

      _isType: function(type, selected){
        if(selected){
          if(this._states[selected.model.id])
            return type === 'state';
          else
            return type === 'relation';
        }
        return false;
      },

      _getIndexOfItemType: function (type, obj) {
        if(type){
          var array = this.customShapesObjToArray(obj);
          if(type.includes("Normal"))
            type = "Attribute";
          for(var i = 0; i < array.length; i++){
            if(type.toLowerCase().replace(/erd./g, '') === (array[i].toLowerCase().replace(/\s/g, '')))
              return i;
          }
        }
      },

      customShapesObjToArray: function (obj) {
        var array=[];
        this._getKeys(obj).forEach(function (arr) {
          array.push("label");
          obj[arr].forEach(function (el) {
            array.push(el);
          });
        });
        return array;
      },

      _getIndexOfItemRel: function (id, obj) {
        var array = this._getKeys(obj);
        for(var i = 0; i < array.length; i++){
          if(id === array[i])
            return i;
        }
      },

      getStateLabel: function (selected) {
        if(selected)
          return selected.model.attr('text/text');
      },

      getRelationLabel: function (selected, which) {
        if(selected) {
          var labels = selected.model.get('labels');
          if(labels){
            if (which === 'source')
              return labels[0].attrs.text.text;
            else if(which === 'target')
              return labels[1].attrs.text.text;
          }
        }
      },
      //
      // _getShapes: function(type){
      //   if(type === "Entity") return this._shapes.states.entities;
      //   else if(type === "Relationship") return this._shapes.states.relationships;
      //   else if(type === "Attribute") return this._shapes.states.attributes;
      // },

      setHeight: function(e,val){
        if(val.value){
          var menu = Polymer.dom(e).localTarget;
          var relativeY = menu.getBoundingClientRect().y - this.getBoundingClientRect().y
          Polymer.dom(menu).querySelector('paper-listbox').style['max-height'] = (this.height/2)+'px';
          if(this.height > relativeY+(this.height/2))
            menu.verticalAlign = 'top';
          else
            menu.verticalAlign = 'bottom';
        }
      },

      _keyHandler: function (evt) {
        if(evt.key === 'Meta') {
          if (evt.type === 'keydown') this.multiModeEnabled = true;
          else if (evt.type === 'keyup') this.multiModeEnabled = false;
        }
      },

      zoomIn: function () {
        this._scale += 0.05;
        this._paper.scale(this._scale,this._scale)
        this._scalePaper()
      },

      zoomOut: function () {
        this._scale -= 0.05;
        this._paper.scale(this._scale,this._scale)
        this._scalePaper()
      },

      getScale: function (scale) {
        return (Math.round(this._scale*100))+'%';
      },

      onDragStart: function(event, x, y) {
        this.dragStartPosition = { x: x*this._scale, y: y*this._scale};
      },

      onDragEnd: function(event, x, y) {
        delete this.dragStartPosition;
      },
      
      dragPaper: function (evt) {
        if (this.dragStartPosition){
          this.$['paper-container'].scrollLeft += (this.dragStartPosition.x - evt.offsetX);
          this.$['paper-container'].scrollTop += (this.dragStartPosition.y - evt.offsetY);
        }
      }

    });
  </script>

</dom-module>
