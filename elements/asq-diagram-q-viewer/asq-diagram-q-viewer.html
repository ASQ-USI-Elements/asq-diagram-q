<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../asq-base/asq-base.html">

<link rel="import" href="asq-diagram-q-viewer-uml.html">
<link rel="import" href="asq-diagram-q-viewer-erd.html">

<!--
`asq-diagram-q`is used to allow the user to draw diagrams like UML's or ER's.

@element asq-diagram-q
@demo demo/index.html
@group ASQ Elements
@blurb Element acting as an editor for diagram questions.
@homepage http://github.com/ASQ-USI-Elements/asq-diagram-q
-->
<dom-module id="asq-diagram-q-viewer">

  <template>
    <template is="dom-if" if="{{_isType('uml', type)}}" restamp>
      <asq-diagram-q-viewer-uml
              role="viewer"
              uid="[[uid]]"
              value="{{value}}"
              width="{{width}}"
              height="{{height}}">
        <content></content>
      </asq-diagram-q-viewer-uml>
    </template>

    <template is="dom-if" if="{{_isType('erd', type)}}" restamp>
      <asq-diagram-q-viewer-erd
              role="viewer"
              uid="[[uid]]"
              value="{{value}}"
              width="{{width}}"
              height="{{height}}">
        <content></content>
      </asq-diagram-q-viewer-erd>
    </template>
  </template>

  <script>
    Polymer({
      is: 'asq-diagram-q-viewer',

      behaviors: [
        ASQ.asqQuestionElementBehavior
      ],

      properties: {

        /**
         * Type of diagram (default is uml)
         * options = 'uml', 'er'
         */
        type: {
          type: String,
          value: 'uml',
          notify: true,
          reflectToAttribute: true
        },

        /**
         * width in pixels of the paper element
         */
        width: {
          type: Number,
          value: 800,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * height in pixels of the paper element
         */
        height: {
          type: Number,
          value: 600,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * An optional initial set of states/relations.
         */
        value: {
          type: Object,
          notify: true
        },

        /**
         * Event bus to communicate with ASQ
         */
        eventBus: {
          type: Object,
          observer: '_eventBusChanged',
          notify: true
        }
      },

      _isType: function (type, thisType) {
        return type === thisType;
      },

      _eventBusChanged: function (eventBus) {
        if (!eventBus) return;
        eventBus.on('asq:question_type', this._onQuestionType.bind(this));
      },

      _onQuestionType: function (evt) {
        if (!evt || !evt.questionType) return;
        if (evt.questionType === 'asq-diagram-q') {
          if (evt.type == 'restoreViewer') {
            this._onRestoreViewer(evt);
          }
        }
      },

      _onRestoreViewer: function (evt) {
        if (!evt.questions) return;
        console.log('_onRestoreViewer')
        // evt.questions.forEach(function (q) {
        //   if (q.uid != this.uid) return;
        //   q.options.forEach(function (option) {
        //     this._updateOption(option.uid, option.value);
        //   }.bind(this));
        // }.bind(this));
      },

      /**
       * Collect answers from inner `asq-option`s and orgnize them
       * into an object.
       *

       {
         uid: this.uid,
         timestamp: new Date(),
         options: options
       }

       */
      submit: function () {
        if (this.role !== this.roles.VIEWER) return;

        var diagram = this.$$('asq-diagram-q-viewer-' + this.type);

        if (diagram.selectedElements.length > 0)
          diagram._deselectJointjsObj();

        var statesIds = Object.keys(diagram._states), relationsIds = Object.keys(diagram._relations);
        var states = [], relations = [];

        statesIds.forEach(function (id) {
          states.push({
            type: diagram._states[id].type,
            id: id,
            state: diagram._states[id].state
          });
        });

        relationsIds.forEach(function (id) {
          var relation = {};
          if (this.type === 'uml') {
            relation.type = diagram._relations[id].type;
          } else if (this.type === 'erd') {
            relation.labels = diagram._relations[id].labels;
          }
          relation.relation = diagram._relations[id].relation;
          relation.relation.source.name = diagram._states[relation.relation.source.id].state.name;
          relation.relation.target.name = diagram._states[relation.relation.target.id].state.name;
          relation.vertices = diagram._graph.getCell(id).get('vertices');
          relations.push(relation);
        }.bind(this));

        return {
          questionUid: this.uid,
          timestamp: new Date(),
          diagram: {
            type: this.type,
            states: states,
            relations: relations
          }
        }
      }

    });

  </script>

</dom-module>
