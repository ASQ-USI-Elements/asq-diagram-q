<link rel="import" href="asq-diagram-q-viewer-uml.html">
<link rel="import" href="asq-diagram-q-viewer-erd.html">
<!--<link rel="import" href="asq-diagram-q-viewer-bpmn.html">-->

<!--
`asq-diagram-q`is used to allow the user to draw diagrams like UML's or ER's.

@element asq-diagram-q
@demo demo/index.html
@group ASQ Elements
@blurb Element acting as an editor for diagram questions.
@homepage http://github.com/ASQ-USI-Elements/asq-diagram-q
-->
<dom-module id="asq-diagram-q-viewer">

  <template>
    <template is="dom-if" if="{{_isType('uml', type)}}" restamp>
      <asq-diagram-q-viewer-uml
              role="viewer"
              uid="[[uid]]"
              value="{{value}}"
              disabled="{{disabled}}"
              width="[[width]]"
              height="[[height]]">
      </asq-diagram-q-viewer-uml>
    </template>

    <template is="dom-if" if="{{_isType('erd', type)}}" restamp>
      <asq-diagram-q-viewer-erd
              role="viewer"
              uid="[[uid]]"
              value="{{value}}"
              disabled="{{disabled}}"
              width="[[width]]"
              height="[[height]]">
      </asq-diagram-q-viewer-erd>
    </template>

    <!--<template is="dom-if" if="{{_isType('bpmn', type)}}" restamp>-->
      <!--<asq-diagram-q-viewer-bpmn-->
              <!--role="viewer"-->
              <!--uid="[[uid]]"-->
              <!--value="{{value}}"-->
              <!--disabled="{{disabled}}"-->
              <!--width="[[width]]"-->
              <!--height="[[height]]">-->
      <!--</asq-diagram-q-viewer-bpmn>-->
    </template>
  </template>

  <script>
    Polymer({
      is: 'asq-diagram-q-viewer',

      behaviors: [
        ASQ.asqQuestionElementBehavior,
        ASQ.diagramQBehavior
      ],

      properties: {

        /**
         * Type of diagram
         */
        type: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * width in pixels of the diagram
         */
        width: {
          type: Number,
          value: 800,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * height in pixels of the diagram
         */
        height: {
          type: Number,
          value: 600,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * An optional initial set of states/relations.
         */
        value: {
          type: Object,
          notify: true,
          observer: '_valueChanged'
        },

        /**
         * Disable or enable the element. Changes will be also
         * propagated to inner propagated elements.
         */
        disabled: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Event bus to communicate with ASQ
         */
        eventBus: {
          type: Object,
          observer: '_eventBusChanged',
          notify: true
        }
      },

      _isType: function (type, thisType) {
        return type === thisType;
      },

      _valueChanged: function (value) {

        var idMap = {};

        if(value){
          var diagram = this.$$('asq-diagram-q-viewer-' + this.type);
          diagram.clear();

          value.states.forEach(function(state){
            var sId;
            if(this.type === 'uml')
              sId = diagram.addState( { type: state.type , name: state.state.name, attributes: state.state.attributes, methods: state.state.methods, position: state.state.position } );
              // sId = diagram.addState(state.type, state.state.name, state.state.attributes, state.state.methods, state.state.position);
            else if(this.type === 'erd')
              sId = diagram.addState( { type: state.type, position: state.state.position, label: state.label } );
              // sId = diagram.addState(state.type, state.state.position, state.label);

            if(state.id)
              idMap[state.id] = sId;
          }.bind(this));

          value.relations.forEach(function(rel){
            var sourceId = idMap[rel.relation.source.id] || this._findStateByName(this.type, diagram._states, rel.relation.source.name);
            var targetId = idMap[rel.relation.target.id] || this._findStateByName(this.type, diagram._states, rel.relation.target.name);

            var rId;
            if(this.type === 'uml')
              rId = diagram.addRelation( { type: rel.type, source: { id: sourceId }, target: { id: targetId } } );
            else if(this.type === 'erd'){
              var sLabel, tLabel;
              if(rel.labels){
                sLabel = rel.labels.sLabel;
                tLabel = rel.labels.tLabel
              }
              rId = diagram.addRelation( { source: { id: sourceId }, target: { id: targetId }, sLabel: sLabel, tLabel: tLabel } );
              // rId = diagram.addRelation( { id: sourceId }, { id: targetId }, sLabel, tLabel );
            }

            if(rel.vertices)
              diagram._graph.getCell(rId).set('vertices',rel.vertices)
          }.bind(this));
          // this.value = undefined;
        }

      },

      _eventBusChanged: function (eventBus) {
        if (!eventBus) return;
        eventBus.on('asq:question_type', this._onQuestionType.bind(this));
      },

      _onQuestionType: function (evt) {
        if (!evt || !evt.questionType) return;
        if (evt.questionType === 'asq-diagram-q') {
          if (evt.type == 'restoreViewer') {
            if (!evt.questions) return;

            evt.questions.forEach(function(q){
              if(q.uid === this.uid)
                this._onRestoreViewer(q.diagram)
            }.bind(this))
          }
        }
      },

      _onRestoreViewer: function (diagram) {
        this.value = diagram
      },

      /**
       * Collect answers from inner `asq-option`s and orgnize them
       * into an object.
       *

       {
         uid: this.uid,
         timestamp: new Date(),
         options: options
       }

       */
      submit: function () {
        if (this.role !== this.roles.VIEWER) return;

        var diagram = this.$$('asq-diagram-q-viewer-' + this.type);

        if (diagram.selectedCounter > 0)
          diagram._deselectJointjsObj();

        var statesIds = Object.keys(diagram._states), relationsIds = Object.keys(diagram._relations);
        var states = [], relations = [];

        statesIds.forEach(function (id) {

          var state = {
            type: diagram._states[id].type,
            id: id,
            state: diagram._states[id].state
          };
          if(this.type === 'erd')
            state.label = diagram._states[id].label;

          states.push(state);
        }.bind(this));

        relationsIds.forEach(function (id) {
          var relation = {
            relation : diagram._relations[id].relation,
            vertices : diagram._graph.getCell(id).get('vertices') ||Â []
          };

          if (this.type === 'uml') {
            relation.type = diagram._relations[id].type;
            relation.relation.source.name = diagram._states[relation.relation.source.id].state.name;
            relation.relation.target.name = diagram._states[relation.relation.target.id].state.name;
          } else if (this.type === 'erd') {
            relation.labels = diagram._relations[id].labels;
            relation.relation.source.name = diagram._states[relation.relation.source.id].label;
            relation.relation.target.name = diagram._states[relation.relation.target.id].label;
          }
          relations.push(relation);
        }.bind(this));

        return {
          questionUid: this.uid,
          timestamp: new Date(),
          diagram: {
            type: this.type,
            states: states,
            relations: relations
          }
        }
      }

    });

  </script>

</dom-module>
